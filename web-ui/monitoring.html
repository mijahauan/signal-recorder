<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAPE Recorder Monitor</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        
        /* Navigation bar */
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .navbar h2 {
            margin: 0;
            font-size: 20px;
        }
        .navbar .nav-links {
            display: flex;
            gap: 15px;
        }
        .navbar a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .navbar a:hover {
            background: rgba(255,255,255,0.1);
        }
        .navbar a.active {
            background: rgba(255,255,255,0.2);
            font-weight: 600;
        }
        
        .content {
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .header h1 { margin: 0 0 5px 0; }
        .header p { margin: 0; opacity: 0.9; }
        
        /* System-wide status summary */
        .system-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        .summary-card .subtext {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        /* Health indicators */
        .health-summary {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .health-indicators {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        .health-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
        }
        .health-badge .count {
            font-size: 24px;
        }
        
        /* Controls */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .btn-refresh {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .btn-refresh:hover { background: #5a6fd8; }
        
        .daemon-status-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .daemon-status-bar .status {
            font-size: 16px;
            font-weight: 600;
        }
        .daemon-status-bar .status.running { color: #4CAF50; }
        .daemon-status-bar .status.stopped { color: #f44336; }
        
        /* Channel cards */
        .channels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .channel-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #ccc;
        }
        .channel-card.healthy { border-left-color: #4CAF50; }
        .channel-card.warning { border-left-color: #ff9800; }
        .channel-card.error { border-left-color: #f44336; }
        
        .channel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .channel-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .channel-freq {
            font-size: 14px;
            color: #666;
        }
        .health-indicator {
            font-size: 24px;
        }
        
        .channel-status {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .metrics-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .metric {
            font-size: 13px;
        }
        .metric-label {
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metric-value {
            font-weight: bold;
            color: #333;
            font-size: 15px;
        }
        .metric-value.good { color: #4CAF50; }
        .metric-value.warning { color: #ff9800; }
        .metric-value.error { color: #f44336; }
        
        /* Data Quality Section */
        .quality-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .quality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .quality-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .quality-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .quality-icon {
            font-size: 24px;
        }
        .quality-metric {
            flex: 1;
        }
        .quality-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .quality-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .quality-value.excellent { color: #4CAF50; }
        .quality-value.good { color: #8BC34A; }
        .quality-value.fair { color: #ff9800; }
        .quality-value.poor { color: #f44336; }
        .quality-details {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            font-size: 13px;
            color: #666;
        }
        .quality-issue {
            padding: 8px 12px;
            margin: 5px 0;
            border-left: 3px solid #ff9800;
            background: #fff3e0;
            border-radius: 4px;
            font-size: 13px;
        }
        .quality-issue.error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        /* Logs */
        .logs-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .logs-content {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        .log-line { padding: 2px 0; }
        .log-line.error { color: #f48771; }
        .log-line.warning { color: #dcdcaa; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h2>üì° GRAPE Signal Recorder</h2>
        <div class="nav-links">
            <a href="/">‚öôÔ∏è Configuration</a>
            <a href="/monitoring.html" class="active">üìä Monitoring</a>
        </div>
    </nav>

    <div class="content">
        <div id="auth-error" style="display: none; background: #fee; color: #c00; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #fcc;">
            <strong>‚ö†Ô∏è Authentication Error:</strong> <span id="auth-error-message"></span>
            <br><small>Please ensure you're logged in via the <a href="/" style="color: #c00; text-decoration: underline;">Configuration page</a> first.</small>
        </div>
        
        <div class="header">
            <h1>üìä Live Monitoring Dashboard</h1>
            <p>Real-time recording status and metrics ‚Ä¢ Auto-refreshes every 30s</p>
        </div>

        <div class="daemon-status-bar">
            <div>
                <span style="color: #666; font-size: 14px;">Daemon Status:</span>
                <span id="daemon-status-text" class="status">Checking...</span>
            </div>
            <button class="btn-refresh" onclick="refreshAll()">üîÑ Refresh Now</button>
        </div>

    <div class="health-summary" id="health-summary" style="display: none;">
        <div class="health-indicators">
            <div class="health-badge">
                üü¢ <span class="count" id="healthy-count">0</span> Healthy
            </div>
            <div class="health-badge">
                üü° <span class="count" id="warning-count">0</span> Warning
            </div>
            <div class="health-badge">
                üî¥ <span class="count" id="error-count">0</span> Error
            </div>
        </div>
        <div style="text-align: right; color: #666; font-size: 14px;">
            <div><strong id="packet-loss-pct">0.00%</strong> Packet Loss</div>
        </div>
    </div>

    <div class="system-summary" id="system-summary" style="display: none;">
        <div class="summary-card">
            <h3>Recording Time</h3>
            <div class="value" id="recording-duration">0m</div>
            <div class="subtext">Active recording session</div>
        </div>
        <div class="summary-card">
            <h3>Total Data</h3>
            <div class="value" id="total-data">0 MB</div>
            <div class="subtext">Across all channels</div>
        </div>
        <div class="summary-card">
            <h3>Packets Received</h3>
            <div class="value" id="total-packets">0</div>
            <div class="subtext" id="packets-per-sec">0/sec</div>
        </div>
        <div class="summary-card">
            <h3>Active Channels</h3>
            <div class="value" id="channel-count">0</div>
            <div class="subtext">Recording streams</div>
        </div>
    </div>

    <!-- Data Quality Validation Section -->
    <div class="quality-section" id="quality-section" style="display: none;">
        <h2 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">üìä Data Quality Validation</h2>
        <div class="quality-grid">
            <div class="quality-card">
                <div class="quality-icon">‚úÖ</div>
                <div class="quality-metric">
                    <div class="quality-label">Overall Quality</div>
                    <div class="quality-value" id="quality-score">--</div>
                </div>
            </div>
            <div class="quality-card">
                <div class="quality-icon">üìà</div>
                <div class="quality-metric">
                    <div class="quality-label">Sample Rate Accuracy</div>
                    <div class="quality-value" id="rate-accuracy">--</div>
                </div>
            </div>
            <div class="quality-card">
                <div class="quality-icon">üì¶</div>
                <div class="quality-metric">
                    <div class="quality-label">Avg Completeness</div>
                    <div class="quality-value" id="avg-completeness">--</div>
                </div>
            </div>
            <div class="quality-card">
                <div class="quality-icon">üéØ</div>
                <div class="quality-metric">
                    <div class="quality-label">Data Continuity</div>
                    <div class="quality-value" id="data-continuity">--</div>
                </div>
            </div>
        </div>
        <div class="quality-details" id="quality-details"></div>
    </div>

    <div id="channels-container" class="channels-grid"></div>

    <div id="error-container"></div>
    <div id="loading-container" class="loading">Loading recording statistics...</div>

        <div class="logs-container">
            <div class="logs-header">
                <h3 style="margin: 0;">üìã Daemon Logs</h3>
                <button class="btn-refresh" onclick="loadLogs()">üîÑ Refresh Logs</button>
            </div>
            <div class="logs-content" id="logs-content">
                <div class="loading">Loading logs...</div>
            </div>
        </div>
    </div> <!-- end content -->

    <script>
        let refreshInterval;

        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('authToken');
            
            // If no token, set default and don't make request yet
            if (!token) {
                console.log('No auth token found, setting default');
                localStorage.setItem('authToken', 'admin-token');
                throw new Error('Authentication token not found - please refresh the page');
            }
            
            const url = `/api${endpoint}`;
            const cacheBustUrl = url + (url.includes('?') ? '&' : '?') + '_t=' + Date.now();

            const response = await fetch(cacheBustUrl, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache',
                    ...options.headers
                },
                cache: 'no-store',
                ...options
            });

            if (response.status === 401) {
                // Show error instead of auto-redirecting
                throw new Error('Authentication failed - please log in via the main configuration page');
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            return await response.json();
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function showAuthError(message) {
            document.getElementById('auth-error-message').textContent = message;
            document.getElementById('auth-error').style.display = 'block';
            document.getElementById('loading-container').style.display = 'none';
        }

        function calculateDataQuality(stats) {
            console.log('calculateDataQuality called', stats);
            if (!stats || !stats.recorders || Object.keys(stats.recorders).length === 0) {
                console.log('No recorders data, hiding quality section');
                document.getElementById('quality-section').style.display = 'none';
                return;
            }

            console.log('Showing quality section with', Object.keys(stats.recorders).length, 'recorders');
            document.getElementById('quality-section').style.display = 'block';

            const recorders = Object.values(stats.recorders);
            let totalCompleteness = 0;
            let totalRateAccuracy = 0;
            let issues = [];
            let excellentCount = 0;

            recorders.forEach(rec => {
                totalCompleteness += rec.completeness_pct;
                
                // Calculate rate accuracy (how close to 10.0 samples/sec)
                const rateAccuracy = 100 - Math.abs((rec.samples_per_sec - 10.0) / 10.0 * 100);
                totalRateAccuracy += Math.max(0, rateAccuracy);

                // Track issues
                if (rec.completeness_pct < 95) {
                    issues.push({
                        type: 'error',
                        message: `${rec.channel_name}: Low completeness (${rec.completeness_pct.toFixed(1)}%)`
                    });
                } else if (rec.completeness_pct < 99) {
                    issues.push({
                        type: 'warning',
                        message: `${rec.channel_name}: Moderate completeness (${rec.completeness_pct.toFixed(1)}%)`
                    });
                } else {
                    excellentCount++;
                }

                if (rec.packet_loss_pct > 1) {
                    issues.push({
                        type: 'error',
                        message: `${rec.channel_name}: Packet loss detected (${rec.packet_loss_pct.toFixed(2)}%)`
                    });
                }

                if (Math.abs(rec.samples_per_sec - 10.0) > 0.5) {
                    issues.push({
                        type: 'error',
                        message: `${rec.channel_name}: Sample rate off target (${rec.samples_per_sec.toFixed(1)}/s vs 10.0/s)`
                    });
                }
            });

            const avgCompleteness = totalCompleteness / recorders.length;
            const avgRateAccuracy = totalRateAccuracy / recorders.length;
            const continuity = (excellentCount / recorders.length * 100);

            // Overall quality score (weighted average)
            const qualityScore = (avgCompleteness * 0.5 + avgRateAccuracy * 0.3 + continuity * 0.2);

            // Update quality metrics
            const qualityEl = document.getElementById('quality-score');
            const accuracyEl = document.getElementById('rate-accuracy');
            const completenessEl = document.getElementById('avg-completeness');
            const continuityEl = document.getElementById('data-continuity');

            // Overall quality
            qualityEl.textContent = qualityScore.toFixed(1) + '%';
            qualityEl.className = 'quality-value ' + getQualityClass(qualityScore);

            // Rate accuracy
            accuracyEl.textContent = avgRateAccuracy.toFixed(1) + '%';
            accuracyEl.className = 'quality-value ' + getQualityClass(avgRateAccuracy);

            // Completeness
            completenessEl.textContent = avgCompleteness.toFixed(1) + '%';
            completenessEl.className = 'quality-value ' + getQualityClass(avgCompleteness);

            // Continuity
            continuityEl.textContent = continuity.toFixed(0) + '%';
            continuityEl.className = 'quality-value ' + getQualityClass(continuity);

            // Display issues
            const detailsEl = document.getElementById('quality-details');
            if (issues.length === 0) {
                detailsEl.innerHTML = '<div style="color: #4CAF50; font-weight: 500;">‚úÖ All channels operating normally. Data pipeline validated.</div>';
            } else {
                detailsEl.innerHTML = issues.map(issue => 
                    `<div class="quality-issue ${issue.type}">${issue.type === 'error' ? 'üî¥' : '‚ö†Ô∏è'} ${issue.message}</div>`
                ).join('');
            }
        }

        function getQualityClass(score) {
            if (score >= 99) return 'excellent';
            if (score >= 95) return 'good';
            if (score >= 90) return 'fair';
            return 'poor';
        }

        async function loadRecordingStats() {
            try {
                const stats = await apiRequest('/monitoring/recording-stats');
                
                if (!stats.available) {
                    document.getElementById('loading-container').innerHTML = 
                        '<div class="loading">‚ö†Ô∏è No recording statistics available - daemon may not be running</div>';
                    document.getElementById('health-summary').style.display = 'none';
                    document.getElementById('system-summary').style.display = 'none';
                    return;
                }

                // Hide loading, show content
                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('health-summary').style.display = 'flex';
                document.getElementById('system-summary').style.display = 'grid';
                document.getElementById('error-container').innerHTML = '';

                // Update health summary
                document.getElementById('healthy-count').textContent = stats.healthy_channels;
                document.getElementById('warning-count').textContent = stats.warning_channels;
                document.getElementById('error-count').textContent = stats.error_channels;
                document.getElementById('packet-loss-pct').textContent = stats.aggregate_packet_loss_pct.toFixed(2) + '%';

                // Update system summary
                document.getElementById('recording-duration').textContent = formatDuration(stats.recording_duration_sec);
                document.getElementById('total-data').textContent = stats.total_data_mb.toFixed(1) + ' MB';
                document.getElementById('total-packets').textContent = formatNumber(stats.total_packets_received);
                document.getElementById('channel-count').textContent = stats.channels;

                const packetsPerSec = stats.recording_duration_sec > 0 ? 
                    (stats.total_packets_received / stats.recording_duration_sec).toFixed(1) : 0;
                document.getElementById('packets-per-sec').textContent = packetsPerSec + ' packets/sec';

                // Render channel cards
                const container = document.getElementById('channels-container');
                container.innerHTML = '';

                for (const [ssrc, rec] of Object.entries(stats.recorders)) {
                    const card = document.createElement('div');
                    card.className = `channel-card ${rec.health_status}`;
                    
                    const indicator = rec.health_status === 'healthy' ? 'üü¢' :
                                    rec.health_status === 'warning' ? 'üü°' : 'üî¥';
                    
                    const completenessClass = rec.completeness_pct >= 99 ? 'good' :
                                            rec.completeness_pct >= 95 ? 'warning' : 'error';
                    
                    const packetLossClass = rec.packet_loss_pct <= 1 ? 'good' :
                                          rec.packet_loss_pct <= 5 ? 'warning' : 'error';
                    
                    card.innerHTML = `
                        <div class="channel-header">
                            <div>
                                <div class="channel-title">${rec.channel_name}</div>
                                <div class="channel-freq">${rec.frequency_mhz.toFixed(2)} MHz</div>
                            </div>
                            <div class="health-indicator">${indicator}</div>
                        </div>
                        <div class="channel-status">
                            ${rec.is_stale ? '‚ö†Ô∏è No data for ' + rec.data_freshness_sec + 's' : rec.health_message}
                        </div>
                        <div class="metrics-row">
                            <div class="metric">
                                <div class="metric-label">Completeness</div>
                                <div class="metric-value ${completenessClass}">${rec.completeness_pct.toFixed(1)}%</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Packet Loss</div>
                                <div class="metric-value ${packetLossClass}">${rec.packet_loss_pct.toFixed(2)}%</div>
                            </div>
                        </div>
                        <div class="metrics-row">
                            <div class="metric">
                                <div class="metric-label">Samples Received</div>
                                <div class="metric-value">${formatNumber(rec.samples_received)}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Sample Rate</div>
                                <div class="metric-value">${rec.samples_per_sec.toFixed(1)}/s</div>
                            </div>
                        </div>
                        <div class="metrics-row">
                            <div class="metric">
                                <div class="metric-label">Files Created</div>
                                <div class="metric-value">${rec.file_count}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Data Written</div>
                                <div class="metric-value">${rec.total_size_mb.toFixed(1)} MB</div>
                            </div>
                        </div>
                        <div class="metrics-row">
                            <div class="metric">
                                <div class="metric-label">Packets</div>
                                <div class="metric-value">${formatNumber(rec.packets_received)}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Duration</div>
                                <div class="metric-value">${formatDuration(rec.recording_duration_sec)}</div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                }

                // Calculate and display data quality metrics
                calculateDataQuality(stats);

            } catch (error) {
                console.error('Failed to load recording stats:', error);
                
                // Check if it's an auth error
                if (error.message.includes('Authentication')) {
                    showAuthError(error.message);
                } else {
                    document.getElementById('error-container').innerHTML =
                        `<div class="error-message">‚ùå Failed to load recording statistics: ${error.message}</div>`;
                    document.getElementById('loading-container').style.display = 'none';
                }
            }
        }

        async function checkDaemonStatus() {
            try {
                const data = await apiRequest('/monitoring/daemon-status');
                const statusText = document.getElementById('daemon-status-text');
                
                if (data.running) {
                    statusText.className = 'status running';
                    statusText.textContent = `‚óè Running (PID: ${data.pid})`;
                } else {
                    statusText.className = 'status stopped';
                    statusText.textContent = '‚óè Stopped';
                }
            } catch (error) {
                const statusText = document.getElementById('daemon-status-text');
                statusText.className = 'status stopped';
                statusText.textContent = '‚óè Unknown';
            }
        }

        async function loadLogs() {
            try {
                const data = await apiRequest('/monitoring/logs');
                const container = document.getElementById('logs-content');
                
                if (data.logs && data.logs.length > 0) {
                    container.innerHTML = data.logs.map(log => {
                        let className = 'log-line';
                        if (log.match(/error|failed|exception/i)) {
                            className += ' error';
                        } else if (log.match(/warning|warn/i)) {
                            className += ' warning';
                        }
                        return `<div class="${className}">${log}</div>`;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="loading">No logs available</div>';
                }
            } catch (error) {
                document.getElementById('logs-content').innerHTML = 
                    '<div class="log-line error">Failed to load logs: ' + error.message + '</div>';
            }
        }

        function refreshAll() {
            checkDaemonStatus();
            loadRecordingStats();
            loadLogs();
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshAll, 30000);

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure auth token is set before making any requests
            let token = localStorage.getItem('authToken');
            if (!token) {
                console.log('Setting default auth token');
                localStorage.setItem('authToken', 'admin-token');
                token = 'admin-token';
            }
            
            console.log('Monitoring page loaded, auth token:', token ? 'present' : 'missing');
            
            // Small delay to ensure token is committed to localStorage
            setTimeout(() => {
                refreshAll();
            }, 100);
        });
    </script>
</body>
</html>
