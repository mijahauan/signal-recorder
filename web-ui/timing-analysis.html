<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timing & Gap Analysis - GRAPE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
        }
        
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .controls {
            background: #1a1f35;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls label {
            font-weight: 600;
        }
        
        .controls input, .controls select, .controls button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #374151;
            background: #0a0e1a;
            color: #e0e0e0;
            font-size: 14px;
        }
        
        .controls button {
            background: #7c3aed;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .controls button:hover {
            background: #6d28d9;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #1a1f35;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .card h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #a78bfa;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #374151;
        }
        
        .stat:last-child {
            border-bottom: none;
        }
        
        .stat-value {
            font-weight: 600;
        }
        
        .grade {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
        }
        
        .grade-A { color: #10b981; }
        .grade-B { color: #3b82f6; }
        .grade-C { color: #f59e0b; }
        .grade-F { color: #ef4444; }
        
        .timeline {
            background: #1a1f35;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .timeline h2 {
            color: #a78bfa;
            margin-bottom: 20px;
        }
        
        .hour-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .hour-label {
            width: 50px;
            color: #9ca3af;
        }
        
        .hour-bar {
            flex: 1;
            height: 24px;
            background: #0a0e1a;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .bar-excellent { background: linear-gradient(90deg, #10b981, #059669); }
        .bar-good { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .bar-fair { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .bar-poor { background: linear-gradient(90deg, #ef4444, #dc2626); }
        
        .hour-value {
            width: 80px;
            text-align: right;
            color: #e0e0e0;
            margin-left: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .error {
            background: #7f1d1d;
            color: #fecaca;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 12px;
            color: #9ca3af;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-box {
            width: 20px;
            height: 12px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Timing & Gap Analysis</h1>
            <p>Detailed analysis of data completeness and timing quality</p>
        </header>
        
        <div class="controls">
            <label>Date:</label>
            <input type="date" id="dateInput" value="">
            
            <label>Channel:</label>
            <select id="channelSelect">
                <option value="">All Channels</option>
                <option value="WWV 10 MHz">WWV 10 MHz</option>
                <option value="WWV 2.5 MHz">WWV 2.5 MHz</option>
                <option value="WWV 5 MHz">WWV 5 MHz</option>
                <option value="WWV 15 MHz">WWV 15 MHz</option>
                <option value="WWV 20 MHz">WWV 20 MHz</option>
                <option value="WWV 25 MHz">WWV 25 MHz</option>
                <option value="CHU 3.33 MHz">CHU 3.33 MHz</option>
                <option value="CHU 7.85 MHz">CHU 7.85 MHz</option>
                <option value="CHU 14.67 MHz">CHU 14.67 MHz</option>
            </select>
            
            <button onclick="loadAnalysis()">Analyze</button>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            ‚è≥ Analyzing data...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="results" style="display: none;">
            <div class="grid">
                <div class="card">
                    <h2>Quality Grade</h2>
                    <div id="gradeDisplay" class="grade">-</div>
                </div>
                
                <div class="card">
                    <h2>Overall Statistics</h2>
                    <div id="statsDisplay"></div>
                </div>
                
                <div class="card">
                    <h2>Time_snap Status</h2>
                    <div id="timeSnapDisplay"></div>
                </div>
            </div>
            
            <div class="timeline">
                <h2>Hourly Completeness</h2>
                <div id="timelineDisplay"></div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box bar-excellent"></div>
                        <span>‚â•99.9% (Excellent)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box bar-good"></div>
                        <span>99.0-99.9% (Good)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box bar-fair"></div>
                        <span>95.0-99.0% (Fair)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box bar-poor"></div>
                        <span><95.0% (Poor)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateInput').value = today;
        
        async function loadAnalysis() {
            const dateInput = document.getElementById('dateInput').value;
            const channel = document.getElementById('channelSelect').value;
            
            if (!dateInput) {
                showError('Please select a date');
                return;
            }
            
            // Convert YYYY-MM-DD to YYYYMMDD
            const date = dateInput.replace(/-/g, '');
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            
            try {
                let url = `/api/v1/timing/analysis?date=${date}`;
                if (channel) {
                    url += `&channel=${encodeURIComponent(channel)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Analysis failed');
                }
                
                displayResults(data);
                
            } catch (err) {
                showError(`Analysis failed: ${err.message}`);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function displayResults(data) {
            // Grade
            const grade = data.summary.quality_grade;
            const gradeElem = document.getElementById('gradeDisplay');
            gradeElem.textContent = grade;
            gradeElem.className = 'grade grade-' + grade.replace('+', '');
            
            // Statistics
            const statsHtml = `
                <div class="stat">
                    <span>Completeness:</span>
                    <span class="stat-value">${data.summary.completeness_percent.toFixed(2)}%</span>
                </div>
                <div class="stat">
                    <span>Total Files:</span>
                    <span class="stat-value">${data.summary.total_files.toLocaleString()}</span>
                </div>
                <div class="stat">
                    <span>Files with Gaps:</span>
                    <span class="stat-value">${data.summary.files_with_gaps.toLocaleString()}</span>
                </div>
                <div class="stat">
                    <span>Total Gaps:</span>
                    <span class="stat-value">${data.summary.total_gaps.toLocaleString()}</span>
                </div>
                <div class="stat">
                    <span>Samples Filled:</span>
                    <span class="stat-value">${data.summary.samples_filled.toLocaleString()}</span>
                </div>
            `;
            document.getElementById('statsDisplay').innerHTML = statsHtml;
            
            // Time_snap
            let timeSnapHtml = '<div class="stat"><span>No time_snap data available</span></div>';
            if (data.time_snap && data.time_snap.current) {
                const ts = data.time_snap.current;
                const utcDate = new Date(ts.utc_timestamp * 1000);
                timeSnapHtml = `
                    <div class="stat">
                        <span>Source:</span>
                        <span class="stat-value">${ts.source}</span>
                    </div>
                    <div class="stat">
                        <span>UTC:</span>
                        <span class="stat-value">${utcDate.toISOString()}</span>
                    </div>
                    <div class="stat">
                        <span>RTP:</span>
                        <span class="stat-value">${ts.rtp_timestamp.toLocaleString()}</span>
                    </div>
                `;
            }
            document.getElementById('timeSnapDisplay').innerHTML = timeSnapHtml;
            
            // Timeline
            let timelineHtml = '';
            for (let hour = 0; hour < 24; hour++) {
                const hourData = data.hourly_breakdown[hour];
                if (hourData && hourData.avg_completeness !== null) {
                    const pct = hourData.avg_completeness;
                    const barClass = pct >= 99.9 ? 'bar-excellent' :
                                    pct >= 99.0 ? 'bar-good' :
                                    pct >= 95.0 ? 'bar-fair' : 'bar-poor';
                    
                    timelineHtml += `
                        <div class="hour-row">
                            <div class="hour-label">${hour.toString().padStart(2, '0')}:xx</div>
                            <div class="hour-bar">
                                <div class="bar-fill ${barClass}" style="width: ${pct}%"></div>
                            </div>
                            <div class="hour-value">${pct.toFixed(1)}%</div>
                        </div>
                    `;
                } else {
                    timelineHtml += `
                        <div class="hour-row">
                            <div class="hour-label">${hour.toString().padStart(2, '0')}:xx</div>
                            <div class="hour-bar" style="opacity: 0.3;"></div>
                            <div class="hour-value">no data</div>
                        </div>
                    `;
                }
            }
            document.getElementById('timelineDisplay').innerHTML = timelineHtml;
            
            // Show results
            document.getElementById('results').style.display = 'block';
        }
        
        function showError(message) {
            const errorElem = document.getElementById('error');
            errorElem.textContent = message;
            errorElem.style.display = 'block';
        }
        
        // Load initial analysis on page load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const date = urlParams.get('date');
            const channel = urlParams.get('channel');
            
            if (date) {
                // Convert YYYYMMDD to YYYY-MM-DD
                const formatted = date.slice(0,4) + '-' + date.slice(4,6) + '-' + date.slice(6,8);
                document.getElementById('dateInput').value = formatted;
            }
            if (channel) {
                document.getElementById('channelSelect').value = channel;
            }
            
            if (date) {
                loadAnalysis();
            }
        });
    </script>
</body>
</html>
