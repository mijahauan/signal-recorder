<!-- Add this section to timing-dashboard.html after the analytics summary -->

<!-- Quality Analysis Section (add to CSS) -->
<style>
.quality-analysis-section {
    background: #1e293b;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 20px;
    border-left: 4px solid #3b82f6;
}

.quality-section-header {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #fff;
}

.quality-metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.quality-metric-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.quality-metric-title {
    font-size: 12px;
    color: #94a3b8;
    text-transform: uppercase;
    margin-bottom: 12px;
    font-weight: 600;
}

.quality-metric-value {
    font-size: 28px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 8px;
}

.quality-metric-comparison {
    font-size: 13px;
    color: #cbd5e1;
    display: flex;
    align-items: center;
    gap: 6px;
}

.quality-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.quality-badge.better {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.quality-badge.worse {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.quality-channel-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
}

.quality-channel-item {
    background: rgba(255, 255, 255, 0.05);
    padding: 10px;
    border-radius: 6px;
    font-size: 13px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.quality-channel-name {
    font-weight: 600;
    color: #e0e0e0;
    margin-bottom: 4px;
}

.quality-channel-stat {
    font-size: 11px;
    color: #94a3b8;
}
</style>

<!-- JavaScript Functions (add to script section) -->
<script>
async function fetchQualityAnalysis() {
    try {
        // Fetch the latest quality report from automated analysis
        const response = await fetch('/quality-analysis/quality_report_latest.json');
        if (!response.ok) return null;
        
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Failed to load quality analysis:', error);
        return null;
    }
}

function renderQualityAnalysis(qualityData) {
    if (!qualityData || !qualityData.summary) {
        return ''; // No quality data yet
    }
    
    const summary = qualityData.summary;
    const channels = qualityData.channels;
    
    // Format timestamp
    const reportTime = new Date(qualityData.generated_at).toLocaleString('en-US', {
        timeZone: 'UTC',
        hour12: false,
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Decimation quality summary
    const snrAdvantage = summary.mean_snr_advantage_db || 0;
    const jitterRatio = summary.mean_jitter_ratio || 1.0;
    const carrierBetter = jitterRatio > 1.0;
    
    // Timing quality summary
    const toneLockedPct = summary.mean_tone_locked_pct || 0;
    const ntpSyncedPct = summary.mean_ntp_synced_pct || 0;
    
    // Build channel details
    const channelCards = Object.entries(channels).map(([chanName, chanData]) => {
        const freq = chanName.replace(/_/g, ' ');
        const dec = chanData.decimation_quality;
        const jitterRatio = dec?.comparison?.phase_jitter_ratio || 1.0;
        const timingDist = chanData.timing_quality?.wide?.timing_distribution || {};
        const toneLocked = timingDist.tone_locked || 0;
        
        return `
            <div class="quality-channel-item">
                <div class="quality-channel-name">${freq}</div>
                <div class="quality-channel-stat">Jitter: ${jitterRatio.toFixed(2)}x</div>
                <div class="quality-channel-stat">Tone: ${toneLocked.toFixed(0)}%</div>
            </div>
        `;
    }).join('');
    
    return `
        <div class="quality-analysis-section">
            <div class="quality-section-header">
                ðŸ“Š Decimation & Timing Quality Analysis
                <span style="margin-left: auto; font-size: 12px; color: #94a3b8;">
                    Updated: ${reportTime} UTC
                </span>
            </div>
            
            <div class="quality-metrics-grid">
                <!-- Decimation Quality: Phase Jitter -->
                <div class="quality-metric-card">
                    <div class="quality-metric-title">Phase Jitter Ratio (Wide/Carrier)</div>
                    <div class="quality-metric-value">
                        ${jitterRatio.toFixed(2)}x
                    </div>
                    <div class="quality-metric-comparison">
                        ${carrierBetter ? 
                            '<span class="quality-badge better">Carrier Cleaner</span>' :
                            '<span class="quality-badge worse">Wide Cleaner</span>'
                        }
                        <span>${carrierBetter ? 
                            `Carrier has ${jitterRatio.toFixed(1)}Ã— less phase noise` :
                            `Wide has ${(1/jitterRatio).toFixed(1)}Ã— less phase noise`
                        }</span>
                    </div>
                </div>
                
                <!-- Decimation Quality: SNR -->
                <div class="quality-metric-card">
                    <div class="quality-metric-title">SNR Difference (Carrier - Wide)</div>
                    <div class="quality-metric-value" style="color: ${snrAdvantage > 0 ? '#10b981' : '#ef4444'};">
                        ${snrAdvantage > 0 ? '+' : ''}${snrAdvantage.toFixed(1)} dB
                    </div>
                    <div class="quality-metric-comparison">
                        ${Math.abs(snrAdvantage) < 2 ? 
                            '<span class="quality-badge better">Equivalent</span>' :
                            snrAdvantage > 0 ? 
                                '<span class="quality-badge better">Carrier Advantage</span>' :
                                '<span class="quality-badge worse">Wide Advantage</span>'
                        }
                        <span>200Hzâ†’10Hz vs 16kHzâ†’10Hz decimation</span>
                    </div>
                </div>
                
                <!-- Timing Quality: Tone Locked -->
                <div class="quality-metric-card">
                    <div class="quality-metric-title">Tone-Locked Coverage (Wide)</div>
                    <div class="quality-metric-value" style="color: ${toneLockedPct > 80 ? '#10b981' : toneLockedPct > 50 ? '#f59e0b' : '#ef4444'};">
                        ${toneLockedPct.toFixed(1)}%
                    </div>
                    <div class="quality-metric-comparison">
                        ${toneLockedPct > 80 ? 
                            '<span class="quality-badge better">Excellent</span>' :
                            toneLockedPct > 50 ?
                                '<span class="quality-badge">Good</span>' :
                                '<span class="quality-badge worse">Poor</span>'
                        }
                        <span>Â±1ms timing via WWV/CHU tone detection</span>
                    </div>
                </div>
                
                <!-- Timing Quality: NTP Synced -->
                <div class="quality-metric-card">
                    <div class="quality-metric-title">NTP-Synced Coverage (Carrier)</div>
                    <div class="quality-metric-value" style="color: ${ntpSyncedPct > 95 ? '#10b981' : ntpSyncedPct > 80 ? '#f59e0b' : '#ef4444'};">
                        ${ntpSyncedPct.toFixed(1)}%
                    </div>
                    <div class="quality-metric-comparison">
                        ${ntpSyncedPct > 95 ? 
                            '<span class="quality-badge better">Excellent</span>' :
                            ntpSyncedPct > 80 ?
                                '<span class="quality-badge">Good</span>' :
                                '<span class="quality-badge worse">Poor</span>'
                        }
                        <span>Â±10ms timing via system NTP</span>
                    </div>
                </div>
            </div>
            
            <!-- Per-channel breakdown -->
            <div style="margin-top: 20px;">
                <div style="font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                    Per-Channel Metrics (${summary.channels_analyzed} analyzed)
                </div>
                <div class="quality-channel-list">
                    ${channelCards}
                </div>
            </div>
        </div>
    `;
}

// Update the renderDashboard function to include quality analysis
// Replace the existing renderDashboard function with this:
async function renderDashboard(data) {
    const container = document.getElementById('dashboard-content');
    
    // System Status
    const systemStatusHtml = renderSystemStatus(data.overall);
    
    // Analytics Summary (WWV/WWVH discrimination)
    const analyticsHtml = renderAnalyticsSummary(data.channels);
    
    // Quality Analysis (NEW)
    const qualityData = await fetchQualityAnalysis();
    const qualityHtml = renderQualityAnalysis(qualityData);
    
    // Channel table
    const channelTableHtml = renderChannelTable(data.channels);
    
    // Alerts
    const alertsHtml = renderAlerts(data.alerts);
    
    container.innerHTML = `
        ${systemStatusHtml}
        ${analyticsHtml}
        ${qualityHtml}
        ${channelTableHtml}
        ${alertsHtml}
    `;
}
</script>
