<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timing Analysis Dashboard - GRAPE Signal Recorder</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script>
        window.GRAPE_CURRENT_PAGE = 'timing';
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            color: #fff;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .live-dot {
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Info Link */
        .info-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            font-size: 11px;
            font-weight: 700;
            text-decoration: none;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .info-link:hover {
            background: #3b82f6;
            color: #fff;
        }
        
        /* Alert Banner */
        .alert-banner {
            background: #dc2626;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .alert-banner.visible {
            display: flex;
        }
        
        .alert-banner.warning {
            background: #f59e0b;
        }
        
        .alert-icon {
            font-size: 24px;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .alert-message {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* GPSDO Anchor Status Panel */
        .gpsdo-panel {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #10b981;
            position: relative;
        }
        
        .gpsdo-panel.holdover {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #1e293b 0%, #1c1917 100%);
        }
        
        .gpsdo-panel.startup,
        .gpsdo-panel.reanchor {
            border-color: #ef4444;
            background: linear-gradient(135deg, #1e293b 0%, #1c1917 100%);
        }
        
        .gpsdo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .gpsdo-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .gpsdo-state-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
        }
        
        .gpsdo-state-badge.green {
            background: #10b981;
            color: #fff;
        }
        
        .gpsdo-state-badge.amber {
            background: #f59e0b;
            color: #fff;
            animation: pulse-amber 2s infinite;
        }
        
        .gpsdo-state-badge.red {
            background: #ef4444;
            color: #fff;
            animation: pulse-red 1.5s infinite;
        }
        
        @keyframes pulse-amber {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes pulse-red {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        
        .gpsdo-state-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .gpsdo-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .gpsdo-metric {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .gpsdo-metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .gpsdo-metric-value.good {
            color: #10b981;
        }
        
        .gpsdo-metric-value.warning {
            color: #f59e0b;
        }
        
        .gpsdo-metric-value.error {
            color: #ef4444;
        }
        
        .gpsdo-metric-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .gpsdo-metric-sub {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }
        
        .gpsdo-description {
            font-size: 13px;
            color: #94a3b8;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .gpsdo-description-icon {
            font-size: 16px;
        }
        
        .verification-sparkline {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 30px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .sparkline-bar {
            width: 8px;
            background: #10b981;
            border-radius: 2px;
            min-height: 2px;
            transition: height 0.3s ease;
        }
        
        .sparkline-bar.warning {
            background: #f59e0b;
        }
        
        .sparkline-bar.error {
            background: #ef4444;
        }
        
        .sparkline-label {
            font-size: 10px;
            color: #64748b;
            margin-left: 10px;
            align-self: center;
        }
        
        /* Primary Reference Hero Section */
        .primary-reference {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            border-left: 5px solid #10b981;
        }
        
        .primary-reference.ntp {
            border-left-color: #3b82f6;
        }
        
        .primary-reference.degraded {
            border-left-color: #f59e0b;
        }
        
        .primary-reference.poor {
            border-left-color: #ef4444;
        }
        
        .ref-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .ref-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }
        
        .quality-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .quality-badge.tone-locked {
            background: #10b981;
            color: #fff;
        }
        
        .quality-badge.ntp-synced {
            background: #3b82f6;
            color: #fff;
        }
        
        .quality-badge.interpolated,
        .quality-badge.tone-aged {
            background: #f59e0b;
            color: #fff;
        }
        
        .quality-badge.tone-stable {
            background: #22c55e;  /* Green - tone-based with excellent drift */
            color: #fff;
        }
        
        .quality-badge.wall-clock {
            background: #ef4444;
            color: #fff;
        }
        
        .ref-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .ref-metric {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
        }
        
        .ref-metric-label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .ref-metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }
        
        .ref-metric-sub {
            font-size: 13px;
            color: #cbd5e1;
        }
        
        .ref-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }
        
        .ref-detail-item {
            display: flex;
            gap: 10px;
            font-size: 13px;
        }
        
        .ref-detail-label {
            color: #94a3b8;
            min-width: 100px;
        }
        
        .ref-detail-value {
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
        }
        
        /* Health Cards Grid */
        .health-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .health-card {
            background: #1e293b;
            border-radius: 10px;
            padding: 25px;
            border-left: 4px solid #3b82f6;
        }
        
        .health-card-title {
            font-size: 14px;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .health-card-value {
            font-size: 36px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }
        
        .health-card-percent {
            font-size: 18px;
            color: #cbd5e1;
            margin-bottom: 15px;
        }
        
        .health-card-quality {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .health-card-quality.excellent {
            background: #10b981;
            color: #fff;
        }
        
        .health-card-quality.good {
            background: #3b82f6;
            color: #fff;
        }
        
        .health-card-quality.fair {
            background: #f59e0b;
            color: #fff;
        }
        
        .health-card-quality.poor {
            background: #ef4444;
            color: #fff;
        }
        
        .health-card-quality.collecting {
            background: rgba(148, 163, 184, 0.3);
            color: #94a3b8;
            font-style: italic;
        }
        
        .health-card-details {
            font-size: 13px;
            color: #cbd5e1;
            line-height: 1.6;
        }
        
        .health-card-details div {
            margin-bottom: 4px;
        }
        
        .channel-list {
            margin-top: 10px;
        }
        
        .channel-item {
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.tone {
            background: #10b981;
        }
        
        .status-dot.ntp {
            background: #3b82f6;
        }
        
        .status-dot.wall {
            background: #ef4444;
        }
        
        /* Charts */
        .chart-section {
            background: #1e293b;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .chart-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            background: #0f172a;
            border-radius: 8px;
        }
        
        /* Per-Channel Table */
        .channel-table-container {
            background: #1e293b;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #0f172a;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        td {
            padding: 12px;
            border-top: 1px solid #334155;
            font-size: 14px;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .health-score {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .health-score.excellent {
            background: #10b981;
            color: #fff;
        }
        
        .health-score.good {
            background: #3b82f6;
            color: #fff;
        }
        
        .health-score.fair {
            background: #f59e0b;
            color: #fff;
        }
        
        .health-score.poor {
            background: #ef4444;
            color: #fff;
        }
        
        /* Transitions Log */
        .transitions-section {
            background: #1e293b;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .transition-item {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid #3b82f6;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
        }
        
        .transition-time {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 6px;
        }
        
        .transition-title {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }
        
        .transition-details {
            font-size: 13px;
            color: #cbd5e1;
            line-height: 1.6;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
            font-size: 16px;
        }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .refresh-countdown {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }
        
        /* Propagation Mode Section */
        .propagation-section {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        
        .section-header {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            display: block;
        }
        
        .section-subtitle {
            font-size: 13px;
            color: #94a3b8;
        }
        
        .prop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .prop-station {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 15px;
        }
        
        .prop-station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #334155;
        }
        
        .prop-station-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        
        .prop-station-distance {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .prop-table {
            width: 100%;
            font-size: 13px;
        }
        
        .prop-table th {
            padding: 8px;
            text-align: left;
            font-size: 10px;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 600;
        }
        
        .prop-table td {
            padding: 8px;
            border-top: 1px solid #1e293b;
        }
        
        .mode-badge {
            display: inline-block;
            background: #3b82f6;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .mode-badge.primary {
            background: #10b981;
        }
        
        .alt-mode {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .alt-mode td {
            padding-top: 2px !important;
            padding-bottom: 2px !important;
        }
        
        .freq-cell {
            vertical-align: middle;
            font-weight: 600;
        }
        
        .primary-mode {
            border-top: 1px solid #334155;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Unified Navigation -->
        <div id="grape-navigation"></div>

        <div class="header">
        <h1>‚è±Ô∏è Timing Analysis Dashboard</h1>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div class="live-indicator">
                <span class="live-dot"></span>
                <span>Live Monitoring</span>
                <span class="refresh-countdown" id="countdown-timer">Next update in 30s</span>
            </div>
        </div>
    </div>

    <!-- Alert Banner -->
    <div class="alert-banner" id="alert-banner">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <div class="alert-content">
            <div class="alert-title" id="alert-title">Critical Timing Issue</div>
            <div class="alert-message" id="alert-message">Loading...</div>
        </div>
    </div>

    <div id="dashboard-content">
        <div class="loading">‚è≥ Loading timing analysis data...</div>
    </div>

    <script>
        let refreshCountdown = 30;
        let countdownInterval = null;
        let autoRefreshInterval = null;
        
        function startCountdown() {
            refreshCountdown = 30;
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                refreshCountdown--;
                const timer = document.getElementById('countdown-timer');
                if (timer) {
                    timer.textContent = `Next update in ${refreshCountdown}s`;
                }
                if (refreshCountdown <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
        }
        
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            
            autoRefreshInterval = setInterval(async () => {
                await loadDashboard();
            }, 30000); // Refresh every 30 seconds
        }
        
        async function loadDashboard() {
            try {
                // Load data for fusion panel, broadcast table, and chrony comparison
                const [phase2Status, fusionData, chronyData] = await Promise.all([
                    fetch('/api/v1/timing/phase2-status').then(r => r.json()).catch(() => ({ available: false })),
                    fetch('/api/v1/timing/fusion').then(r => r.json()).catch(() => ({ status: 'no_data' })),
                    fetch('/api/v1/system/chrony').then(r => r.json()).catch(() => ({ available: false }))
                ]);
                
                renderDashboard(phase2Status, fusionData, chronyData);
                startCountdown();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="error">
                        ‚ùå Failed to load timing data: ${error.message}
                        <br><br>
                        Please ensure analytics service is running and generating timing metrics.
                    </div>
                `;
            }
        }
        
        function renderDashboard(phase2Status, fusionData, chronyData) {
            const container = document.getElementById('dashboard-content');
            
            // Extract channel names for chart dropdowns from phase2 status
            if (phase2Status.channels) {
                availableChannels = window.GRAPE_UTILS.sortChannelsByFrequency(
                    Object.keys(phase2Status.channels)
                );
            }
            
            // Store phase2 data globally for chart loading
            window.phase2ChannelStatus = phase2Status;
            window.fusionData = fusionData;
            window.chronyData = chronyData;
            
            // Phase 2 D_clock focused layout - zeroing in on UTC(NIST)
            container.innerHTML = `
                ${renderFusionPanel(fusionData)}
                ${renderChronyComparison(chronyData, fusionData)}
                ${renderBroadcastTable(phase2Status)}
                ${renderDClockChartPlaceholder()}
            `;
            
            // Load charts after DOM is ready
            setTimeout(() => {
                loadCharts();
            }, 100);
        }
        
        function renderGpsdoStatus(data) {
            if (!data || !data.available) {
                // Show startup/unavailable state
                return `
                    <div class="gpsdo-panel startup">
                        <div class="gpsdo-header">
                            <div class="gpsdo-title">‚öì GPSDO Anchor Status</div>
                            <span class="gpsdo-state-badge red">
                                <span class="gpsdo-state-dot"></span>
                                STARTUP
                            </span>
                        </div>
                        <div class="gpsdo-description">
                            <span class="gpsdo-description-icon">üîç</span>
                            <span>GPSDO monitor initializing - waiting for first tone detection to establish anchor...</span>
                        </div>
                    </div>
                `;
            }
            
            // Determine panel class based on state
            const panelClass = data.anchor_state === 'STEADY_STATE' ? '' :
                              data.anchor_state === 'HOLDOVER' ? 'holdover' : 'reanchor';
            
            // Format verification error with appropriate color
            let verifyErrorClass = 'good';
            let verifyErrorValue = '‚Äî';
            if (data.last_verification_error_ms !== null) {
                const absError = Math.abs(data.last_verification_error_ms);
                verifyErrorValue = `¬±${absError.toFixed(2)}`;
                if (absError > 5.0) verifyErrorClass = 'error';
                else if (absError > 1.0) verifyErrorClass = 'warning';
            }
            
            // Format trend
            let trendClass = 'good';
            let trendValue = '‚Äî';
            if (data.verification_trend_ms !== null) {
                const absTrend = Math.abs(data.verification_trend_ms);
                trendValue = `¬±${absTrend.toFixed(2)}`;
                if (absTrend > 3.0) trendClass = 'error';
                else if (absTrend > 0.5) trendClass = 'warning';
            }
            
            // Build verification history sparkline
            let sparklineHtml = '';
            if (data.verification_history && data.verification_history.length > 0) {
                const maxVal = 5.0; // 5ms scale
                const bars = data.verification_history.slice(-20).map(err => {
                    const absErr = Math.abs(err);
                    const height = Math.min(100, (absErr / maxVal) * 100);
                    const barClass = absErr > 3.0 ? 'error' : absErr > 1.0 ? 'warning' : '';
                    return `<div class="sparkline-bar ${barClass}" style="height: ${Math.max(5, height)}%"></div>`;
                }).join('');
                
                sparklineHtml = `
                    <div class="verification-sparkline">
                        ${bars}
                        <span class="sparkline-label">Last ${data.verification_history.length} verifications (¬±5ms scale)</span>
                    </div>
                `;
            }
            
            // State badge icon
            const stateIcon = data.anchor_state === 'STEADY_STATE' ? '‚úì' :
                             data.anchor_state === 'HOLDOVER' ? '‚ö†' : '‚ü≥';
            
            // Format state display name
            const stateDisplay = data.anchor_state.replace('_', ' ');
            
            return `
                <div class="gpsdo-panel ${panelClass}">
                    <div class="gpsdo-header">
                        <div class="gpsdo-title">‚öì GPSDO Anchor Status</div>
                        <span class="gpsdo-state-badge ${data.state_color}">
                            <span class="gpsdo-state-dot"></span>
                            ${stateIcon} ${stateDisplay}
                        </span>
                    </div>
                    
                    <div class="gpsdo-metrics">
                        <div class="gpsdo-metric">
                            <div class="gpsdo-metric-value good">${data.minutes_since_anchor}</div>
                            <div class="gpsdo-metric-label">Minutes Stable</div>
                            <div class="gpsdo-metric-sub">${data.consecutive_verifications} verifications</div>
                        </div>
                        
                        <div class="gpsdo-metric">
                            <div class="gpsdo-metric-value ${verifyErrorClass}">${verifyErrorValue}</div>
                            <div class="gpsdo-metric-label">Last Verify (ms)</div>
                            <div class="gpsdo-metric-sub">Best: ${data.best_station || '‚Äî'}</div>
                        </div>
                        
                        <div class="gpsdo-metric">
                            <div class="gpsdo-metric-value ${trendClass}">${trendValue}</div>
                            <div class="gpsdo-metric-label">Trend (ms)</div>
                            <div class="gpsdo-metric-sub">Rolling average</div>
                        </div>
                        
                        <div class="gpsdo-metric">
                            <div class="gpsdo-metric-value">${data.total_reanchors}</div>
                            <div class="gpsdo-metric-label">Re-anchors</div>
                            <div class="gpsdo-metric-sub">Total session</div>
                        </div>
                    </div>
                    
                    <div class="gpsdo-description">
                        <span class="gpsdo-description-icon">${data.anchor_state === 'STEADY_STATE' ? 'üì°' : '‚ö†Ô∏è'}</span>
                        <span>${data.state_description}</span>
                        ${data.best_channel ? `<span style="margin-left: auto; color: #64748b;">Channel: ${data.best_channel}</span>` : ''}
                    </div>
                    
                    ${sparklineHtml}
                </div>
            `;
        }
        
        function renderBestDClock(data) {
            // Hide this panel when fusion is active - fusion panel is the primary display
            if (window.fusionData && window.fusionData.status === 'active') {
                return ''; // Fusion panel replaces this
            }
            
            if (!data || !data.available) {
                return `
                    <div class="d-clock-panel" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
                                border: 2px solid #334155; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <span style="font-size: 24px;">üéØ</span>
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: #fff;">UTC(NIST) Clock Offset</div>
                                <div style="font-size: 13px; color: #94a3b8;">Converging to true UTC - Awaiting Data</div>
                            </div>
                        </div>
                        <div style="color: #64748b; text-align: center; padding: 20px;">
                            Waiting for Phase 2 analytics to compute D_clock from broadcast timing...
                        </div>
                    </div>
                `;
            }
            
            const gradeColors = { 'A': '#22c55e', 'B': '#3b82f6', 'C': '#eab308', 'D': '#f97316', 'X': '#ef4444' };
            const gradeColor = gradeColors[data.quality_grade] || '#94a3b8';
            const dClockStr = `${data.d_clock_ms >= 0 ? '+' : ''}${data.d_clock_ms.toFixed(3)} ms`;
            
            // Explain what the offset means
            const offsetExplanation = data.d_clock_ms >= 0 
                ? `System clock is ${Math.abs(data.d_clock_ms).toFixed(1)}ms ahead of UTC(NIST)`
                : `System clock is ${Math.abs(data.d_clock_ms).toFixed(1)}ms behind UTC(NIST)`;
            
            return `
                <div class="d-clock-panel" style="background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%); 
                            border: 2px solid ${gradeColor}; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <span style="font-size: 24px;">üéØ</span>
                                <div>
                                    <div style="font-size: 18px; font-weight: 600; color: #fff;">UTC(NIST) Clock Offset</div>
                                    <div style="font-size: 13px; color: #94a3b8;">Best estimate from ${data.channel}</div>
                                </div>
                            </div>
                            <div style="font-size: 48px; font-weight: 700; color: ${gradeColor}; font-family: 'Monaco', 'Menlo', monospace;">
                                ${dClockStr}
                            </div>
                            <div style="font-size: 14px; color: #cbd5e1; margin-top: 8px;">
                                ${offsetExplanation}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 30px; text-align: center;">
                            <div>
                                <div style="font-size: 36px; font-weight: 700; color: ${gradeColor};">${data.quality_grade}</div>
                                <div style="font-size: 12px; color: #94a3b8; text-transform: uppercase;">Confidence</div>
                            </div>
                            <div>
                                <div style="font-size: 36px; font-weight: 600; color: #e0e0e0;">${data.station || '‚Äî'}</div>
                                <div style="font-size: 12px; color: #94a3b8; text-transform: uppercase;">Station</div>
                            </div>
                            ${data.snr_db ? `
                            <div>
                                <div style="font-size: 36px; font-weight: 600; color: #e0e0e0;">${data.snr_db.toFixed(1)}</div>
                                <div style="font-size: 12px; color: #94a3b8; text-transform: uppercase;">SNR (dB)</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px 15px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                        <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">
                            <strong>How D_clock works:</strong> Each channel detects WWV/WWVH/CHU broadcast timing, 
                            subtracts propagation delay, and computes T<sub>system</sub> ‚àí T<sub>UTC(NIST)</sub>. 
                            The best-quality measurement becomes the reference for aligning all channels.
                        </div>
                        <div style="display: flex; gap: 20px; font-size: 12px;">
                            <span style="color: #22c55e;">‚óè A = Sub-ms precision</span>
                            <span style="color: #3b82f6;">‚óè B = 1-3ms precision</span>
                            <span style="color: #eab308;">‚óè C = 3-10ms</span>
                            <span style="color: #f97316;">‚óè D = Low confidence</span>
                            <span style="color: #ef4444;">‚óè X = No measurement</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Helper: render station calibration card with convergence indicator
        function renderStationCalibration(station, location, mainColor, lightColor, textColor, freqs, cal) {
            const n = cal?.n_samples || 0;
            const offset = cal?.offset_ms;
            const uncertainty = cal?.uncertainty_ms || 1.0;
            
            // Convergence: 100% at 50 samples with low uncertainty
            const sampleProgress = Math.min(100, (n / 50) * 100);
            const uncertaintyProgress = Math.min(100, Math.max(0, (1 - uncertainty / 2) * 100));
            const convergence = Math.round((sampleProgress * 0.6) + (uncertaintyProgress * 0.4));
            
            const convergeLabel = convergence >= 95 ? '‚úì Locked' : 
                                  convergence >= 50 ? 'Converging' : 
                                  n === 0 ? 'No signal' : 'Learning';
            const convergeColor = convergence >= 95 ? '#22c55e' : 
                                  convergence >= 50 ? '#eab308' : '#64748b';
            
            const freqBadges = freqs.map(f => 
                `<span style="background: ${mainColor}33; padding: 3px 8px; border-radius: 4px; font-size: 11px; color: ${lightColor};">${f} MHz</span>`
            ).join('');
            
            const offsetStr = offset !== undefined ? 
                `${offset >= 0 ? '+' : ''}${offset.toFixed(2)} ms` : '‚Äî';
            
            return `
                <div style="background: ${mainColor}22; padding: 12px; border-radius: 8px; border-left: 3px solid ${mainColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-size: 13px; font-weight: 600; color: ${mainColor};">
                            ${station} <span style="font-weight: 400; color: ${lightColor};">(${location})</span>
                        </div>
                        <span style="font-size: 10px; color: ${convergeColor}; font-weight: 600;">${convergeLabel}</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${freqBadges}
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 11px; color: ${textColor};">
                            Offset: ${offsetStr}
                        </div>
                        <div style="font-size: 10px; color: ${lightColor};">
                            ${n} samples
                        </div>
                    </div>
                    <!-- Convergence progress bar -->
                    <div style="margin-top: 6px; height: 3px; background: ${mainColor}33; border-radius: 2px; overflow: hidden;">
                        <div style="width: ${convergence}%; height: 100%; background: ${convergence >= 95 ? '#22c55e' : mainColor}; transition: width 0.3s;"></div>
                    </div>
                </div>
            `;
        }
        
        function renderFusionPanel(data) {
            if (!data || data.status !== 'active' || !data.latest) {
                return `
                    <div class="fusion-panel" style="background: linear-gradient(135deg, #064e3b 0%, #022c22 100%); 
                                border: 2px solid #10b981; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">üîÄ</span>
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: #fff;">Multi-Broadcast Fusion</div>
                                <div style="font-size: 13px; color: #6ee7b7;">Combining 13 broadcasts ‚Üí UTC(NIST)</div>
                            </div>
                        </div>
                        <div style="color: #6ee7b7; text-align: center; padding: 20px;">
                            Waiting for fusion service to collect calibration data...
                        </div>
                    </div>
                `;
            }
            
            const f = data.latest;
            const gradeColors = { 'A': '#22c55e', 'B': '#3b82f6', 'C': '#eab308', 'D': '#f97316' };
            const gradeColor = gradeColors[f.quality_grade] || '#94a3b8';
            
            // Fused value (calibrated to UTC)
            const fusedStr = `${f.d_clock_fused_ms >= 0 ? '+' : ''}${f.d_clock_fused_ms.toFixed(4)} ms`;
            // Raw value (before calibration)
            const rawStr = `${f.d_clock_raw_ms >= 0 ? '+' : ''}${f.d_clock_raw_ms.toFixed(2)} ms`;
            
            // Calibration info - aggregate by station
            const rawCal = data.calibration || {};
            const cal = { WWV: { n_samples: 0 }, WWVH: { n_samples: 0 }, CHU: { n_samples: 0 } };
            
            // Aggregate calibration data by station
            for (const [key, c] of Object.entries(rawCal)) {
                const station = c.station;
                if (cal[station]) {
                    cal[station].n_samples += c.n_samples || 0;
                    // Use weighted average for offset (by samples)
                    if (cal[station].offset_ms === undefined) {
                        cal[station].offset_ms = c.offset_ms;
                        cal[station].uncertainty_ms = c.uncertainty_ms;
                    } else {
                        // Simple average for display
                        cal[station].offset_ms = (cal[station].offset_ms + c.offset_ms) / 2;
                    }
                }
            }
            
            const calEntries = Object.entries(rawCal).map(([key, c]) => 
                `${key}: ${c.offset_ms >= 0 ? '+' : ''}${c.offset_ms.toFixed(2)}ms`
            ).join(' | ');
            
            return `
                <div class="fusion-panel" style="background: linear-gradient(135deg, #064e3b 0%, #022c22 100%); 
                            border: 2px solid #10b981; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <span style="font-size: 24px;">üéØ</span>
                                <div>
                                    <div style="font-size: 18px; font-weight: 600; color: #fff;">
                                        UTC(NIST) Alignment
                                        <a href="/docs/timing-methodology.html#fusion" class="info-link" title="How fusion works">?</a>
                                    </div>
                                    <div style="font-size: 13px; color: #6ee7b7;">Multi-broadcast fusion from ${f.n_broadcasts} broadcasts</div>
                                </div>
                            </div>
                            <div style="font-size: 56px; font-weight: 700; color: #10b981; font-family: 'Monaco', 'Menlo', monospace;">
                                ${fusedStr}
                            </div>
                            <div style="font-size: 14px; color: #6ee7b7; margin-top: 8px;">
                                Target: 0.0000 ms = Perfect UTC(NIST) alignment
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 25px; text-align: center;">
                            <div>
                                <div style="font-size: 32px; font-weight: 700; color: ${gradeColor};">${f.quality_grade}</div>
                                <div style="font-size: 11px; color: #6ee7b7; text-transform: uppercase;">Grade</div>
                            </div>
                            <div>
                                <div style="font-size: 32px; font-weight: 600; color: #f97316;">${rawStr}</div>
                                <div style="font-size: 11px; color: #6ee7b7; text-transform: uppercase;">Raw (uncal)</div>
                            </div>
                            <div>
                                <div style="font-size: 32px; font-weight: 600; color: #e0e0e0;">¬±${f.uncertainty_ms.toFixed(2)}</div>
                                <div style="font-size: 11px; color: #6ee7b7; text-transform: uppercase;">Uncertainty</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 13 Broadcast Matrix with Convergence -->
                    <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <!-- WWV Column -->
                        ${renderStationCalibration('WWV', 'Colorado', '#10b981', '#6ee7b7', '#34d399', 
                            ['2.5', '5', '10', '15', '20', '25'], cal.WWV)}
                        
                        <!-- WWVH Column -->
                        ${renderStationCalibration('WWVH', 'Hawaii', '#3b82f6', '#93c5fd', '#60a5fa',
                            ['2.5', '5', '10', '15'], cal.WWVH)}
                        
                        <!-- CHU Column -->
                        ${renderStationCalibration('CHU', 'Canada', '#f59e0b', '#fcd34d', '#fbbf24',
                            ['3.33', '7.85', '14.67'], cal.CHU)}
                    </div>
                    
                    <div style="margin-top: 12px; font-size: 12px; color: #6ee7b7; text-align: center;">
                        Fusing <strong>${f.n_broadcasts}</strong> of 13 possible broadcasts ‚Ä¢ Calibration learned from ${Object.values(cal).reduce((sum, c) => sum + (c.n_samples || 0), 0)} samples
                    </div>
                </div>
            `;
        }
        
        // Chrony NTP comparison panel
        function renderChronyComparison(chronyData, fusionData) {
            if (!chronyData || !chronyData.available) {
                return `
                    <div style="background: #1e293b; border-radius: 10px; padding: 15px; margin-bottom: 20px; 
                                border: 1px solid #334155; opacity: 0.6;">
                        <div style="font-size: 14px; color: #94a3b8;">
                            ‚è±Ô∏è System NTP Reference (chrony): Unavailable
                        </div>
                    </div>
                `;
            }
            
            const lastOffset = chronyData.last_offset_ms;
            const rmsOffset = chronyData.rms_offset_ms;
            const refName = chronyData.reference_name || chronyData.reference_id || 'unknown';
            const stratum = chronyData.stratum || '?';
            
            // Format the offset
            const offsetStr = lastOffset !== undefined 
                ? `${lastOffset >= 0 ? '+' : ''}${lastOffset.toFixed(3)} ms`
                : '‚Äî';
            const rmsStr = rmsOffset !== undefined 
                ? `¬±${rmsOffset.toFixed(3)} ms`
                : '‚Äî';
            
            // Get GRAPE fusion offset for comparison
            let grapeOffset = '‚Äî';
            let deltaStr = '‚Äî';
            if (fusionData && fusionData.status === 'active' && fusionData.latest) {
                const grapeMs = fusionData.latest.d_clock_fused_ms;
                grapeOffset = `${grapeMs >= 0 ? '+' : ''}${grapeMs.toFixed(3)} ms`;
                if (lastOffset !== undefined) {
                    const delta = grapeMs - lastOffset;
                    deltaStr = `${delta >= 0 ? '+' : ''}${delta.toFixed(3)} ms`;
                }
            }
            
            return `
                <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 10px; 
                            padding: 15px 20px; margin-bottom: 20px; border: 1px solid #475569;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 18px;">‚è±Ô∏è</span>
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: #fff;">System NTP Reference</div>
                                <div style="font-size: 12px; color: #94a3b8;">chrony ‚Üí ${refName} (stratum ${stratum})</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 30px; text-align: center;">
                            <div>
                                <div style="font-size: 20px; font-weight: 600; color: #60a5fa; font-family: monospace;">${offsetStr}</div>
                                <div style="font-size: 10px; color: #94a3b8; text-transform: uppercase;">Last Sample</div>
                            </div>
                            <div>
                                <div style="font-size: 20px; font-weight: 600; color: #94a3b8; font-family: monospace;">${rmsStr}</div>
                                <div style="font-size: 10px; color: #94a3b8; text-transform: uppercase;">RMS Range</div>
                            </div>
                            <div style="border-left: 1px solid #334155; padding-left: 20px;">
                                <div style="font-size: 20px; font-weight: 600; color: #10b981; font-family: monospace;">${grapeOffset}</div>
                                <div style="font-size: 10px; color: #94a3b8; text-transform: uppercase;">GRAPE Fusion</div>
                            </div>
                            <div>
                                <div style="font-size: 20px; font-weight: 600; color: #f59e0b; font-family: monospace;">${deltaStr}</div>
                                <div style="font-size: 10px; color: #94a3b8; text-transform: uppercase;">Œî (GRAPE‚àíNTP)</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 13-Broadcast D_clock Status Table
        function renderBroadcastTable(phase2Status) {
            if (!phase2Status || !phase2Status.available) {
                return `
                    <div class="broadcast-table-container" style="background: #1e293b; border-radius: 10px; 
                                padding: 20px; margin-bottom: 20px; border: 1px solid #334155;">
                        <div style="font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 10px;">
                            üìª 13-Broadcast D_clock Status
                            <a href="/docs/timing-methodology.html#d-clock" class="info-link" title="What is D_clock?">?</a>
                        </div>
                        <div style="color: #64748b; text-align: center; padding: 20px;">
                            Waiting for Phase 2 analytics...
                        </div>
                    </div>
                `;
            }
            
            // Define all 13 broadcasts grouped by station
            const broadcasts = [
                // WWV broadcasts (6)
                { id: 'WWV 2.5 MHz', station: 'WWV', freq: 2.5, channel: 'WWV 2.5 MHz' },
                { id: 'WWV 5 MHz', station: 'WWV', freq: 5, channel: 'WWV 5 MHz' },
                { id: 'WWV 10 MHz', station: 'WWV', freq: 10, channel: 'WWV 10 MHz' },
                { id: 'WWV 15 MHz', station: 'WWV', freq: 15, channel: 'WWV 15 MHz' },
                { id: 'WWV 20 MHz', station: 'WWV', freq: 20, channel: 'WWV 20 MHz' },
                { id: 'WWV 25 MHz', station: 'WWV', freq: 25, channel: 'WWV 25 MHz' },
                // WWVH broadcasts (4) - shared frequencies with WWV
                { id: 'WWVH 2.5 MHz', station: 'WWVH', freq: 2.5, channel: 'WWV 2.5 MHz' },
                { id: 'WWVH 5 MHz', station: 'WWVH', freq: 5, channel: 'WWV 5 MHz' },
                { id: 'WWVH 10 MHz', station: 'WWVH', freq: 10, channel: 'WWV 10 MHz' },
                { id: 'WWVH 15 MHz', station: 'WWVH', freq: 15, channel: 'WWV 15 MHz' },
                // CHU broadcasts (3)
                { id: 'CHU 3.33 MHz', station: 'CHU', freq: 3.33, channel: 'CHU 3.33 MHz' },
                { id: 'CHU 7.85 MHz', station: 'CHU', freq: 7.85, channel: 'CHU 7.85 MHz' },
                { id: 'CHU 14.67 MHz', station: 'CHU', freq: 14.67, channel: 'CHU 14.67 MHz' }
            ];
            
            const stationColors = { 'WWV': '#10b981', 'WWVH': '#3b82f6', 'CHU': '#f59e0b' };
            
            const rows = broadcasts.map(b => {
                const chData = phase2Status.channels?.[b.channel];
                const color = stationColors[b.station];
                
                // Check if this broadcast is the detected station for its channel
                let dClock = '‚Äî';
                let confidence = '‚Äî';
                let snr = '‚Äî';
                let lastUpdate = '‚Äî';
                let isActive = false;
                
                if (chData && chData.available) {
                    // For WWV/WWVH shared channels, only show D_clock if this station is detected
                    const detectedStation = chData.station;
                    if (b.station === 'CHU' || detectedStation === b.station || detectedStation === 'UNKNOWN') {
                        if (chData.d_clock_ms !== undefined && chData.d_clock_ms !== null) {
                            dClock = `${chData.d_clock_ms >= 0 ? '+' : ''}${chData.d_clock_ms.toFixed(2)}`;
                            isActive = true;
                        }
                        
                        // Confidence based on quality metrics
                        const snrDb = chData.quality_metrics?.last_snr_db;
                        if (snrDb !== undefined) {
                            snr = snrDb.toFixed(1);
                            confidence = snrDb > 25 ? 'High' : snrDb > 15 ? 'Med' : 'Low';
                        }
                        
                        // Last update time
                        if (chData.last_updated) {
                            const dt = new Date(chData.last_updated);
                            lastUpdate = dt.toISOString().substr(11, 5);
                        }
                    }
                }
                
                const rowStyle = isActive ? '' : 'opacity: 0.5;';
                const confColor = confidence === 'High' ? '#22c55e' : confidence === 'Med' ? '#eab308' : '#64748b';
                
                return `
                    <tr style="${rowStyle}">
                        <td style="border-left: 3px solid ${color}; padding-left: 12px;">
                            <span style="color: ${color}; font-weight: 600;">${b.station}</span>
                            <span style="color: #94a3b8; margin-left: 8px;">${b.freq} MHz</span>
                        </td>
                        <td style="text-align: right; font-family: monospace; font-weight: 600;">
                            ${dClock !== '‚Äî' ? `<span style="color: #e0e0e0;">${dClock}</span>` : '<span style="color: #64748b;">‚Äî</span>'}
                        </td>
                        <td style="text-align: center;">
                            <span style="color: ${confColor}; font-size: 12px;">${confidence}</span>
                        </td>
                        <td style="text-align: right; color: #94a3b8;">${snr !== '‚Äî' ? snr + ' dB' : '‚Äî'}</td>
                        <td style="text-align: right; color: #64748b; font-size: 12px;">${lastUpdate}</td>
                    </tr>
                `;
            }).join('');
            
            return `
                <div class="broadcast-table-container" style="background: #1e293b; border-radius: 10px; 
                            padding: 20px; margin-bottom: 20px; border: 1px solid #334155;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="font-size: 16px; font-weight: 600; color: #fff;">
                            üìª 13-Broadcast D_clock Status
                            <a href="/docs/timing-methodology.html#d-clock" class="info-link" title="What is D_clock?">?</a>
                        </div>
                        <div style="font-size: 12px; color: #64748b;">
                            Raw uncalibrated measurements ‚Üí Fusion
                        </div>
                    </div>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid #334155;">
                                <th style="text-align: left; padding: 8px 12px; color: #94a3b8; font-weight: 500;">Broadcast</th>
                                <th style="text-align: right; padding: 8px; color: #94a3b8; font-weight: 500;">D_clock (ms)</th>
                                <th style="text-align: center; padding: 8px; color: #94a3b8; font-weight: 500;">Conf</th>
                                <th style="text-align: right; padding: 8px; color: #94a3b8; font-weight: 500;">SNR</th>
                                <th style="text-align: right; padding: 8px; color: #94a3b8; font-weight: 500;">Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderPhase2PipelineOverview(data) {
            if (!data || !data.available) {
                return `
                    <div class="phase2-pipeline" style="background: #1e293b; border: 1px solid #334155; 
                                border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 10px;">
                            üì° Per-Channel UTC Alignment
                        </div>
                        <div style="color: #64748b; text-align: center; padding: 20px;">
                            Waiting for Phase 2 analytics to process channels...
                        </div>
                    </div>
                `;
            }
            
            const summary = data.summary || {};
            const dClockCount = summary.with_d_clock || 0;
            const totalChannels = summary.total_channels || 0;
            const gradeAB = (summary.grade_a_count || 0) + (summary.grade_b_count || 0);
            
            const gradeColors = { 'A': '#22c55e', 'B': '#3b82f6', 'C': '#eab308', 'D': '#f97316', 'X': '#ef4444' };
            
            // Build per-channel alignment rows - sorted by quality grade
            const channelEntries = Object.entries(data.channels || {})
                .filter(([_, status]) => status.available)
                .sort((a, b) => {
                    const gradeOrder = { 'A': 0, 'B': 1, 'C': 2, 'D': 3, 'X': 4 };
                    return (gradeOrder[a[1].quality_grade] || 5) - (gradeOrder[b[1].quality_grade] || 5);
                });
            
            const channelRows = channelEntries.map(([name, status]) => {
                const gradeColor = gradeColors[status.quality_grade] || '#64748b';
                const dClockMs = status.d_clock_ms;
                const hasDClock = dClockMs !== undefined;
                
                const dClockDisplay = hasDClock 
                    ? `${dClockMs >= 0 ? '+' : ''}${dClockMs.toFixed(2)} ms` 
                    : '‚Äî';
                
                // Show alignment status relative to best D_clock
                const alignmentStatus = hasDClock ? '‚úì Aligned' : '‚ãØ Pending';
                const alignmentColor = hasDClock ? '#22c55e' : '#64748b';
                
                return `
                    <div style="display: grid; grid-template-columns: 140px 1fr 100px 60px 80px; 
                                align-items: center; gap: 12px; padding: 10px 12px; 
                                background: rgba(30,41,59,0.5); border-radius: 6px; border-left: 3px solid ${gradeColor};">
                        <span style="font-weight: 600; color: #e0e0e0;">${name}</span>
                        <span style="font-size: 12px; color: ${alignmentColor};">${alignmentStatus}</span>
                        <span style="font-family: monospace; font-size: 14px; font-weight: 600; color: ${gradeColor}; text-align: right;">
                            ${dClockDisplay}
                        </span>
                        <span style="text-align: center; color: #94a3b8; font-size: 12px;">
                            ${status.station || '‚Äî'}
                        </span>
                        <span style="background: ${gradeColor}; color: #fff; padding: 3px 10px; border-radius: 4px; 
                                    font-size: 12px; font-weight: 600; text-align: center;">${status.quality_grade || '‚Äî'}</span>
                    </div>
                `;
            }).join('');
            
            // Add pending channels
            const pendingChannels = Object.entries(data.channels || {})
                .filter(([_, status]) => !status.available)
                .map(([name, _]) => `
                    <div style="display: grid; grid-template-columns: 140px 1fr 100px 60px 80px; 
                                align-items: center; gap: 12px; padding: 10px 12px; 
                                background: rgba(100,116,139,0.1); border-radius: 6px; border-left: 3px solid #475569;">
                        <span style="font-weight: 600; color: #94a3b8;">${name}</span>
                        <span style="font-size: 12px; color: #64748b;">‚è≥ Initializing...</span>
                        <span style="color: #64748b; text-align: right;">‚Äî</span>
                        <span style="text-align: center; color: #64748b;">‚Äî</span>
                        <span style="background: #475569; color: #94a3b8; padding: 3px 10px; border-radius: 4px; 
                                    font-size: 12px; text-align: center;">‚Äî</span>
                    </div>
                `).join('');
            
            return `
                <div class="phase2-pipeline" style="background: #1e293b; border: 1px solid #334155; 
                            border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 16px; font-weight: 600; color: #fff;">
                                üì° Per-Channel UTC Alignment
                            </div>
                            <div style="font-size: 13px; color: #94a3b8;">
                                Each channel independently computes its offset from UTC(NIST)
                            </div>
                        </div>
                        <div style="display: flex; gap: 20px; text-align: center;">
                            <div style="background: rgba(34,197,94,0.15); padding: 8px 16px; border-radius: 6px;">
                                <div style="font-size: 20px; font-weight: 600; color: #22c55e;">${dClockCount}/${totalChannels}</div>
                                <div style="font-size: 10px; color: #94a3b8;">Aligned</div>
                            </div>
                            <div style="background: rgba(59,130,246,0.15); padding: 8px 16px; border-radius: 6px;">
                                <div style="font-size: 20px; font-weight: 600; color: #3b82f6;">${gradeAB}</div>
                                <div style="font-size: 10px; color: #94a3b8;">High Quality</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 140px 1fr 100px 60px 80px; 
                                gap: 12px; padding: 8px 12px; font-size: 11px; color: #64748b; 
                                border-bottom: 1px solid #334155; margin-bottom: 8px;">
                        <span>CHANNEL</span>
                        <span>STATUS</span>
                        <span style="text-align: right;">D_clock</span>
                        <span style="text-align: center;">STATION</span>
                        <span style="text-align: center;">GRADE</span>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        ${channelRows}
                        ${pendingChannels}
                    </div>
                </div>
            `;
        }
        
        function renderPrimaryReference(data) {
            if (!data.available) {
                return `
                    <div class="primary-reference poor">
                        <div class="ref-header">
                            <div class="ref-title">üéØ Primary Time Reference</div>
                            <span class="quality-badge wall-clock">No Reference</span>
                        </div>
                        <div style="color: #fca5a5; font-size: 14px;">
                            No time reference available. Check core recorder status.
                        </div>
                    </div>
                `;
            }
            
            // Use effective_quality for display if available, fall back to quality
            const displayQuality = data.effective_quality || data.quality;
            const qualityClass = displayQuality.toLowerCase().replace('_', '-');
            const borderClass = displayQuality === 'TONE_LOCKED' || displayQuality === 'TONE_STABLE' ? '' :
                               displayQuality === 'NTP_SYNCED' ? 'ntp' :
                               displayQuality === 'TONE_AGED' || displayQuality === 'INTERPOLATED' ? 'degraded' : 'poor';
            
            return `
                <div class="primary-reference ${borderClass}">
                    <div class="ref-header">
                        <div class="ref-title">üéØ Primary Time Reference</div>
                        <span class="quality-badge ${qualityClass}">${data.quality}</span>
                    </div>
                    
                    <div class="ref-grid">
                        <div class="ref-metric">
                            <div class="ref-metric-label">Source</div>
                            <div class="ref-metric-value">${data.source_channel}</div>
                            <div class="ref-metric-sub">Station: ${data.station}</div>
                        </div>
                        
                        <div class="ref-metric">
                            <div class="ref-metric-label">Precision</div>
                            <div class="ref-metric-value">
                                ${data.precision_ms < 10 ? 
                                  `¬±${data.precision_ms} ms` : 
                                  data.precision_ms < 100 ? 
                                  `¬±${data.precision_ms} ms` :
                                  `¬±${(data.precision_ms/1000).toFixed(1)} sec`}
                            </div>
                            <div class="ref-metric-sub">
                                ${data.snr_db ? `SNR: ${data.snr_db.toFixed(1)} dB | ` : ''}
                                Conf: ${(data.confidence * 100).toFixed(0)}%
                            </div>
                        </div>
                        
                        <div class="ref-metric">
                            <div class="ref-metric-label">Age</div>
                            <div class="ref-metric-value">${formatAge(data.age_seconds)}</div>
                            <div class="ref-metric-sub">Next check: ${formatAge(data.next_check_seconds)}</div>
                        </div>
                        
                        <div class="ref-metric">
                            <div class="ref-metric-label">Base Reference</div>
                            <div class="ref-metric-value">
                                ${data.base_reference || (data.tone_frequency_hz ? `${data.tone_frequency_hz} Hz tone` : 'No Tone')}
                            </div>
                            <div class="ref-metric-sub">
                                ${data.precision_description || (
                                  data.is_tone_based ? 'Tone-derived timing' :
                                  data.quality === 'NTP_SYNCED' ? 'NTP synchronized' :
                                  'Unsynchronized clock'
                                )}
                            </div>
                        </div>
                    </div>
                    
                    <div class="ref-details">
                        <div class="ref-detail-item">
                            <span class="ref-detail-label">RTP Anchor:</span>
                            <span class="ref-detail-value">${data.rtp_anchor}</span>
                        </div>
                        <div class="ref-detail-item">
                            <span class="ref-detail-label">UTC Anchor:</span>
                            <span class="ref-detail-value">${data.utc_anchor_iso}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderGlobalTiming(data) {
            if (!data || !data.available || !data.latest) {
                return `
                    <div class="propagation-section" style="margin-bottom: 20px; border: 2px dashed #334155;">
                        <div class="section-header">
                            <h2 class="section-title">üåê Global Differential Timing</h2>
                            <div class="section-subtitle">Cross-Channel Clock Error Estimation - Waiting for data</div>
                        </div>
                        <div style="color: #94a3b8; padding: 20px; text-align: center;">
                            Global timing requires detections from multiple channels simultaneously.<br>
                            Using differential measurements eliminates clock error contamination.
                        </div>
                    </div>
                `;
            }
            
            const g = data.latest;
            const gradeColors = { 'A': '#22c55e', 'B': '#84cc16', 'C': '#eab308', 'D': '#ef4444' };
            const gradeColor = gradeColors[g.quality_grade] || '#94a3b8';
            const verifiedIcon = g.verified ? '‚úì Verified' : '‚óã Unverified';
            const clockStr = `${g.clock_error_ms >= 0 ? '+' : ''}${g.clock_error_ms.toFixed(3)} ms`;
            const uncertStr = `¬±${g.uncertainty_ms.toFixed(3)} ms`;
            
            // Mode assignments table
            const modeRows = (g.mode_assignments || []).map(m => `
                <tr>
                    <td style="font-weight: 600;">${m.station}</td>
                    <td>${m.frequency_mhz} MHz</td>
                    <td><span class="mode-badge">${m.mode}</span></td>
                    <td>${m.n_hops}-hop</td>
                    <td>${m.delay_ms.toFixed(2)} ms</td>
                    <td style="color: #94a3b8;">${m.timing_ms.toFixed(2)} ms</td>
                </tr>
            `).join('');
            
            return `
                <div class="propagation-section" style="margin-bottom: 20px; border: 2px solid ${gradeColor};">
                    <div class="section-header">
                        <h2 class="section-title">üåê Global Differential Timing</h2>
                        <div class="section-subtitle">Cross-Channel Clock Error Estimation - ${g.n_channels} channels, ${g.n_pairs} pairs</div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%); 
                                border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px;">
                                    Host Clock Error (vs UTC)
                                </div>
                                <div style="font-size: 32px; font-weight: 700; color: ${gradeColor}; font-family: monospace;">
                                    ${clockStr} ${uncertStr}
                                </div>
                            </div>
                            <div style="display: flex; gap: 24px; text-align: center;">
                                <div>
                                    <div style="font-size: 28px; font-weight: 600; color: ${gradeColor};">${g.quality_grade}</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Grade</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: 600;">${g.n_channels}</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Channels</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: 600;">${(g.confidence * 100).toFixed(0)}%</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Confidence</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: 600;">${g.pair_consistency_ms.toFixed(2)}</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Consistency (ms)</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #94a3b8;">
                            ${verifiedIcon} | 
                            Minute: ${UTCTime.formatTime(g.minute_utc)} UTC |
                            Updated: ${UTCTime.formatTime(g.last_updated)} UTC
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px;">
                        <div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px;">Mode Assignments</div>
                        <table class="prop-table">
                            <thead>
                                <tr>
                                    <th>Station</th>
                                    <th>Frequency</th>
                                    <th>Mode</th>
                                    <th>Hops</th>
                                    <th>Delay</th>
                                    <th>Observed</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${modeRows || '<tr><td colspan="6" style="color:#64748b">No mode data</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function renderTransmissionTime(data) {
            if (!data.results || data.results.length === 0) {
                return `
                    <div class="propagation-section" style="margin-bottom: 20px;">
                        <div class="section-header">
                            <h2 class="section-title">üéØ UTC(NIST) Back-Calculation</h2>
                            <div class="section-subtitle">Virtual Atomic Clock - Awaiting Data</div>
                        </div>
                        <div style="color: #94a3b8; padding: 20px; text-align: center;">
                            No transmission time data yet. Requires good WWV/WWVH/CHU signal detection.
                        </div>
                    </div>
                `;
            }
            
            // Combined estimate banner
            let combinedBanner = '';
            if (data.combined) {
                const c = data.combined;
                const gradeColors = { 'A': '#22c55e', 'B': '#84cc16', 'C': '#eab308', 'D': '#ef4444' };
                const gradeColor = gradeColors[c.quality_grade] || '#94a3b8';
                const verifiedIcon = c.verified ? '‚úì' : '‚óã';
                const offsetStr = `${c.utc_offset_ms >= 0 ? '+' : ''}${c.utc_offset_ms.toFixed(3)} ms`;
                const uncertStr = `¬±${c.uncertainty_ms.toFixed(3)} ms`;
                
                combinedBanner = `
                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%); 
                                border: 1px solid ${gradeColor}; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px;">
                                    Combined UTC(NIST) Estimate
                                </div>
                                <div style="font-size: 28px; font-weight: 700; color: ${gradeColor}; font-family: monospace;">
                                    ${offsetStr} ${uncertStr}
                                </div>
                            </div>
                            <div style="display: flex; gap: 24px; text-align: center;">
                                <div>
                                    <div style="font-size: 24px; font-weight: 600; color: ${gradeColor};">${c.quality_grade}</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Grade</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: 600;">${c.n_stations}</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Stations</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: 600;">${c.n_measurements}</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Measurements</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: 600;">${(c.consistency * 100).toFixed(0)}%</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Consistency</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #94a3b8;">
                            Stations: ${c.stations.join(', ')} | 
                            ${c.verified ? '‚úì Verified' : '‚óã Unverified'} |
                            Last 5 minutes
                        </div>
                    </div>
                `;
            }
            
            // Get latest result per channel
            const latestByChannel = {};
            for (const r of data.results) {
                if (!latestByChannel[r.channel] || new Date(r.timestamp) > new Date(latestByChannel[r.channel].timestamp)) {
                    latestByChannel[r.channel] = r;
                }
            }
            
            const rows = Object.values(latestByChannel).map(r => {
                const hasOffset = r.utc_nist_offset_ms !== null && r.confidence > 0.3;
                const verifiedIcon = hasOffset ? (r.utc_nist_verified ? '‚úì' : '‚óã') : '';
                const verifiedClass = r.utc_nist_verified ? 'color: #22c55e;' : 'color: #94a3b8;';
                const confColor = r.confidence > 0.7 ? '#22c55e' : r.confidence > 0.5 ? '#eab308' : r.confidence > 0.3 ? '#f97316' : '#94a3b8';
                const offsetDisplay = hasOffset 
                    ? `${r.utc_nist_offset_ms >= 0 ? '+' : ''}${r.utc_nist_offset_ms.toFixed(2)} ms` 
                    : '<span style="color: #64748b; font-style: italic;">mode only</span>';
                
                return `
                    <tr>
                        <td style="font-weight: 600;">${r.frequency_mhz} MHz</td>
                        <td>${r.station}</td>
                        <td>${r.mode}</td>
                        <td>${r.n_hops}</td>
                        <td>${r.propagation_delay_ms.toFixed(2)} ms</td>
                        <td style="${verifiedClass} font-weight: 600;">${offsetDisplay} ${verifiedIcon}</td>
                        <td><span style="color: ${confColor};">${(r.confidence * 100).toFixed(0)}%</span></td>
                        <td style="color: #94a3b8; font-size: 11px;">${UTCTime.formatTime(r.timestamp)} UTC</td>
                    </tr>
                `;
            }).join('');
            
            return `
                <div class="propagation-section" style="margin-bottom: 20px;">
                    <div class="section-header">
                        <h2 class="section-title">üéØ UTC(NIST) Back-Calculation</h2>
                        <div class="section-subtitle">Virtual Atomic Clock - ${data.count} measurements from ${new Set(data.results.map(r => r.station)).size} stations</div>
                    </div>
                    
                    ${combinedBanner}
                    
                    <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">Individual Channel Measurements:</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.05); text-align: left;">
                                <th style="padding: 10px;">Freq</th>
                                <th style="padding: 10px;">Station</th>
                                <th style="padding: 10px;">Mode</th>
                                <th style="padding: 10px;">Hops</th>
                                <th style="padding: 10px;">Prop Delay</th>
                                <th style="padding: 10px;">UTC(NIST) Offset</th>
                                <th style="padding: 10px;">Confidence</th>
                                <th style="padding: 10px;">Last Update</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderHealthCards(data) {
            const toneLockPct = parseFloat(data.tone_lock_percentage);
            const driftQuality = data.drift.quality;
            const jitterQuality = data.jitter.quality;
            const stabilityQuality = data.transitions.stability;
            
            // Build channel list for tone-locked
            const toneChannels = data.channels
                .filter(ch => ch.quality === 'TONE_LOCKED')
                .map(ch => `
                    <div class="channel-item">
                        <span class="status-dot tone"></span>
                        ${ch.channel}
                    </div>
                `).join('');
            
            const ntpChannels = data.channels
                .filter(ch => ch.quality === 'NTP_SYNCED')
                .map(ch => `
                    <div class="channel-item">
                        <span class="status-dot ntp"></span>
                        ${ch.channel}
                    </div>
                `).join('');
            
            return `
                <div class="health-cards">
                    <div class="health-card">
                        <div class="health-card-title">Tone-Locked Channels</div>
                        <div class="health-card-value">${data.tone_locked_channels}/${data.total_channels}</div>
                        <div class="health-card-percent">${toneLockPct.toFixed(0)}%</div>
                        <div class="channel-list">
                            ${toneChannels}
                            ${ntpChannels}
                        </div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-card-title">RTP Drift (Average)</div>
                        <div class="health-card-value">¬±${data.drift.average_ms} ms</div>
                        <div class="health-card-quality ${driftQuality}">${driftQuality}</div>
                        <div class="health-card-details">
                            <div>Range: ${data.drift.range_ms} ms</div>
                            <div>Max: ${data.drift.max_ms} ms</div>
                            <div>Trend: Stable</div>
                        </div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-card-title">Jitter (Stability)</div>
                        <div class="health-card-value">
                            ${parseFloat(data.jitter.average_ms) > 1000 ? 
                              'Stabilizing...' : 
                              `¬±${data.jitter.average_ms} ms`}
                        </div>
                        <div class="health-card-quality ${parseFloat(data.jitter.average_ms) > 1000 ? 'collecting' : jitterQuality}">
                            ${parseFloat(data.jitter.average_ms) > 1000 ? 
                              'collecting data' : 
                              jitterQuality}
                        </div>
                        <div class="health-card-details">
                            <div>Lower is better</div>
                            <div>Target: < 0.5 ms</div>
                            ${parseFloat(data.jitter.average_ms) > 1000 ? 
                              '<div style="color: #94a3b8; font-size: 12px; margin-top: 8px;">Waiting for more timing data...</div>' : ''}
                        </div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-card-title">Transitions (24h)</div>
                        <div class="health-card-value">${data.transitions.last_24h}</div>
                        <div class="health-card-quality ${stabilityQuality}">${stabilityQuality}</div>
                        <div class="health-card-details">
                            <div>Stability: ${stabilityQuality}</div>
                            <div>${data.transitions.last_24h < 10 ? 'Very stable' : 
                                       data.transitions.last_24h < 20 ? 'Stable' :
                                       'Check propagation'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderChannelTable(data, phase2Status) {
            // Sort channels by frequency
            const sortedChannels = window.GRAPE_UTILS.sortByChannelFrequency(data.channels, 'channel');
            const gradeColors = { 'A': '#22c55e', 'B': '#3b82f6', 'C': '#eab308', 'D': '#f97316', 'X': '#ef4444' };
            
            const rows = sortedChannels.map(ch => {
                const healthClass = ch.health_score >= 90 ? 'excellent' :
                                   ch.health_score >= 70 ? 'good' :
                                   ch.health_score >= 50 ? 'fair' : 'poor';
                
                const qualityClass = ch.quality.toLowerCase().replace('_', '-');
                
                // Format jitter - show "stabilizing" if > 1000ms
                const jitterDisplay = ch.jitter_ms > 1000 ? 
                    '<span style="color: #94a3b8;">stabilizing</span>' :
                    `${ch.jitter_ms.toFixed(3)} ms`;
                
                // Format drift - highlight if significant
                const driftDisplay = Math.abs(ch.drift_ms) > 10 ?
                    `<span style="color: #ef4444;">${ch.drift_ms.toFixed(3)} ms</span>` :
                    `${ch.drift_ms.toFixed(3)} ms`;
                
                // Get Phase 2 D_clock data for this channel
                const phase2Ch = phase2Status?.channels?.[ch.channel];
                let dClockDisplay = '<span style="color: #64748b;">‚Äî</span>';
                let gradeDisplay = '<span style="color: #64748b;">‚Äî</span>';
                let stationDisplay = '<span style="color: #64748b;">‚Äî</span>';
                let modeDisplay = '<span style="color: #64748b;">‚Äî</span>';
                
                if (phase2Ch && phase2Ch.available && phase2Ch.d_clock_ms !== undefined) {
                    const dClockMs = phase2Ch.d_clock_ms;
                    const grade = phase2Ch.quality_grade || 'X';
                    const gradeColor = gradeColors[grade] || '#64748b';
                    
                    dClockDisplay = `<span style="font-family: monospace; color: ${gradeColor}; font-weight: 600;">
                        ${dClockMs >= 0 ? '+' : ''}${dClockMs.toFixed(2)}
                    </span>`;
                    gradeDisplay = `<span style="background: ${gradeColor}; color: #fff; padding: 2px 8px; 
                                          border-radius: 4px; font-size: 11px; font-weight: 600;">${grade}</span>`;
                    stationDisplay = phase2Ch.station || '‚Äî';
                }
                
                return `
                    <tr>
                        <td><strong>${ch.channel}</strong></td>
                        <td><span class="quality-badge ${qualityClass}">${ch.quality}</span></td>
                        <td style="text-align: right;">${dClockDisplay}</td>
                        <td style="text-align: center;">${gradeDisplay}</td>
                        <td style="text-align: center;">${stationDisplay}</td>
                        <td style="text-align: right;">${driftDisplay}</td>
                        <td style="text-align: right;">${jitterDisplay}</td>
                        <td><span class="health-score ${healthClass}">${ch.health_score}/100</span></td>
                    </tr>
                `;
            }).join('');
            
            return `
                <div class="channel-table-container">
                    <div class="chart-header">üìã Per-Channel Timing Detail (with Phase 2 D_clock)</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th>Quality</th>
                                <th style="text-align: right;">D_clock (ms)</th>
                                <th style="text-align: center;">Grade</th>
                                <th style="text-align: center;">Station</th>
                                <th style="text-align: right;">RTP Drift</th>
                                <th style="text-align: right;">Jitter</th>
                                <th>Health</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderChartPlaceholders() {
            return `
                <div class="chart-section">
                    <div class="chart-header">
                        üìà RTP Drift Analysis
                        <select id="drift-channel-select" onchange="loadDriftChart()" style="margin-left: 20px; padding: 5px 10px; background: #1e293b; color: #e0e0e0; border: 1px solid #334155; border-radius: 4px;">
                            <option value="all">All Channels</option>
                        </select>
                        <select id="drift-hours-select" onchange="loadDriftChart()" style="margin-left: 10px; padding: 5px 10px; background: #1e293b; color: #e0e0e0; border: 1px solid #334155; border-radius: 4px;">
                            <option value="1">Last 1 Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                        </select>
                    </div>
                    <div class="chart-container" id="drift-chart" style="height: 350px;"></div>
                </div>
                
                <div class="chart-section">
                    <div class="chart-header">
                        üïê Time Source Timeline
                        <select id="timeline-hours-select" onchange="loadTimelineChart()" style="margin-left: 20px; padding: 5px 10px; background: #1e293b; color: #e0e0e0; border: 1px solid #334155; border-radius: 4px;">
                            <option value="6">Last 6 Hours</option>
                            <option value="12">Last 12 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                        </select>
                    </div>
                    <div class="chart-container" id="timeline-chart" style="height: 400px;"></div>
                </div>
                
                <!-- Quality Level Legend -->
                <div class="chart-section" style="padding: 20px 25px;">
                    <div class="chart-header" style="margin-bottom: 15px;">üìñ Time Quality Levels</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="background: #10b981; color: #fff; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; white-space: nowrap;">TONE_LOCKED</span>
                            <span style="color: #cbd5e1; font-size: 13px; line-height: 1.4;">Fresh tone detection (&lt;5 min). Highest precision (¬±1ms). Time derived from WWV/CHU tone edge at minute boundary.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="background: #22c55e; color: #fff; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; white-space: nowrap;">TONE_STABLE</span>
                            <span style="color: #cbd5e1; font-size: 13px; line-height: 1.4;">Aged tone reference with excellent RTP drift (&lt;1ms). Precision still good despite age - ADC clock is tracking well.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="background: #f59e0b; color: #fff; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; white-space: nowrap;">TONE_AGED</span>
                            <span style="color: #cbd5e1; font-size: 13px; line-height: 1.4;">Aged tone reference (>5 min). Precision degrades ~1ms/hour as ADC clock drifts. Still better than NTP if recent.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="background: #3b82f6; color: #fff; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; white-space: nowrap;">NTP_SYNCED</span>
                            <span style="color: #cbd5e1; font-size: 13px; line-height: 1.4;">Using NTP-synchronized system clock. Good precision (¬±10ms). Fallback when no tone available.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="background: #ef4444; color: #fff; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; white-space: nowrap;">WALL_CLOCK</span>
                            <span style="color: #cbd5e1; font-size: 13px; line-height: 1.4;">Unsynchronized system clock. Low precision (¬±seconds). Only at startup before first tone detection.</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; font-size: 13px; color: #10b981;">
                        üí° <strong>Key insight:</strong> RTP drift is the true measure of timing quality. If drift is &lt;1ms, timing is excellent regardless of how old the tone reference is.
                    </div>
                </div>
            `;
        }
        
        function renderDClockChartPlaceholder() {
            return `
                <div class="chart-section">
                    <div class="chart-header">
                        üéØ D_clock Time Series (Phase 2)
                        <a href="/docs/timing-methodology.html#kalman-funnel" class="info-link" title="Understanding D_clock charts">?</a>
                        <select id="dclock-channel-select" onchange="loadDClockChart()" style="margin-left: 20px; padding: 5px 10px; background: #1e293b; color: #e0e0e0; border: 1px solid #334155; border-radius: 4px;">
                            <option value="">Select Channel...</option>
                        </select>
                        <select id="dclock-hours-select" onchange="loadDClockChart()" style="margin-left: 10px; padding: 5px 10px; background: #1e293b; color: #e0e0e0; border: 1px solid #334155; border-radius: 4px;">
                            <option value="1">Last 1 Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                        </select>
                    </div>
                    <div class="chart-container" id="dclock-chart" style="height: 350px;"></div>
                    <div id="dclock-stats" style="display: flex; justify-content: center; gap: 40px; padding: 15px; 
                                background: rgba(30,58,138,0.2); border-radius: 6px; margin-top: 10px;">
                        <div style="text-align: center; color: #94a3b8;">Select a channel to view D_clock measurements</div>
                    </div>
                </div>
                
                <!-- D_clock Quality Grades Legend -->
                <div class="chart-section" style="padding: 20px 25px;">
                    <div class="chart-header" style="margin-bottom: 15px;">üìä D_clock Quality Grades</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="background: #22c55e; color: #fff; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; white-space: nowrap;">Grade A</span>
                            <span style="color: #cbd5e1; font-size: 13px; line-height: 1.4;">Excellent - UTC verified + ground truth OR multi-method agreement. Uncertainty &lt;1ms.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="background: #3b82f6; color: #fff; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; white-space: nowrap;">Grade B</span>
                            <span style="color: #cbd5e1; font-size: 13px; line-height: 1.4;">Good - High confidence from single station with strong signal. Uncertainty 1-3ms.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="background: #eab308; color: #fff; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; white-space: nowrap;">Grade C</span>
                            <span style="color: #cbd5e1; font-size: 13px; line-height: 1.4;">Moderate - Acceptable confidence. May have propagation uncertainty. Uncertainty 3-10ms.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="background: #f97316; color: #fff; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; white-space: nowrap;">Grade D</span>
                            <span style="color: #cbd5e1; font-size: 13px; line-height: 1.4;">Low - Limited confidence. Propagation mode uncertain or weak signal.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="background: #ef4444; color: #fff; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; white-space: nowrap;">Grade X</span>
                            <span style="color: #cbd5e1; font-size: 13px; line-height: 1.4;">No measurement - Tone detection failed or no valid solution found.</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-size: 13px; color: #3b82f6;">
                        üí° <strong>D_clock = T<sub>system</sub> ‚àí T<sub>UTC</sub></strong>: The clock offset represents how far the system clock differs from true UTC. 
                        A value of +2.5ms means the system clock is 2.5ms ahead of UTC.
                    </div>
                </div>
            `;
        }
        
        function renderTransitions(data) {
            if (data.count === 0) {
                return `
                    <div class="transitions-section">
                        <div class="chart-header">üîÑ Recent Time Source Transitions</div>
                        <div style="text-align: center; padding: 40px; color: #10b981;">
                            ‚úÖ No transitions in the last 24 hours - excellent stability!
                        </div>
                    </div>
                `;
            }
            
            const items = data.transitions.slice(0, 10).map(t => {
                return `
                    <div class="transition-item">
                        <div class="transition-time">${UTCTime.formatDateTime(t.timestamp)}</div>
                        <div class="transition-title">
                            ${t.channel}: ${t.from_quality} ‚Üí ${t.to_quality}
                        </div>
                        <div class="transition-details">
                            ‚îú‚îÄ Reason: ${t.reason}<br>
                            ${t.last_snr_db ? `‚îú‚îÄ Last SNR: ${t.last_snr_db.toFixed(1)} dB<br>` : ''}
                            ‚îú‚îÄ Previous duration: ${t.duration_on_previous_source_minutes.toFixed(0)} minutes<br>
                            ‚îî‚îÄ Source: ${t.from_source} ‚Üí ${t.to_source}
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="transitions-section">
                    <div class="chart-header">üîÑ Recent Time Source Transitions (Last 24h: ${data.count})</div>
                    ${items}
                </div>
            `;
        }
        
        // Store channel list for dropdown population
        let availableChannels = [];
        
        // Track user's chart selections to preserve across refresh
        let userSelectedChannel = null;
        let userSelectedHours = null;
        
        function loadCharts() {
            // Populate D_clock channel dropdown, preserving user selection
            populateDClockDropdown();
            // Only auto-select if user hasn't made a selection yet
            if (!userSelectedChannel) {
                autoSelectDClockChannel();
            } else {
                // Restore user's previous selection
                const select = document.getElementById('dclock-channel-select');
                const hoursSelect = document.getElementById('dclock-hours-select');
                if (select && userSelectedChannel) select.value = userSelectedChannel;
                if (hoursSelect && userSelectedHours) hoursSelect.value = userSelectedHours;
                loadDClockChart();
            }
        }
        
        function populateChannelDropdown() {
            const select = document.getElementById('drift-channel-select');
            if (!select || availableChannels.length === 0) return;
            
            // Keep "All Channels" option
            select.innerHTML = '<option value="all">All Channels</option>';
            
            // Add each channel
            availableChannels.forEach(ch => {
                const option = document.createElement('option');
                option.value = ch;
                option.textContent = ch;
                select.appendChild(option);
            });
        }
        
        function populateDClockDropdown() {
            const select = document.getElementById('dclock-channel-select');
            if (!select || availableChannels.length === 0) return;
            
            // Keep "Select Channel" option
            select.innerHTML = '<option value="">Select Channel...</option>';
            
            // Add each channel
            availableChannels.forEach(ch => {
                const option = document.createElement('option');
                option.value = ch;
                option.textContent = ch;
                select.appendChild(option);
            });
        }
        
        function autoSelectDClockChannel() {
            // If Phase 2 status has a channel with D_clock, auto-select it
            const phase2Status = window.phase2ChannelStatus;
            if (!phase2Status || !phase2Status.available) return;
            
            const select = document.getElementById('dclock-channel-select');
            if (!select) return;
            
            // Find first channel with D_clock data
            for (const [channelName, status] of Object.entries(phase2Status.channels || {})) {
                if (status.available && status.d_clock_ms !== undefined) {
                    select.value = channelName;
                    loadDClockChart();
                    break;
                }
            }
        }
        
        async function loadDClockChart() {
            const channelSelect = document.getElementById('dclock-channel-select');
            const hoursSelect = document.getElementById('dclock-hours-select');
            const chartDiv = document.getElementById('dclock-chart');
            const statsDiv = document.getElementById('dclock-stats');
            
            if (!chartDiv) return;
            
            const selectedChannel = channelSelect ? channelSelect.value : '';
            const hours = hoursSelect ? parseInt(hoursSelect.value) : 24;
            
            // Save user's selection for persistence across refresh
            if (selectedChannel) userSelectedChannel = selectedChannel;
            if (hoursSelect) userSelectedHours = hoursSelect.value;
            
            if (!selectedChannel) {
                chartDiv.innerHTML = '<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #64748b;">Select a channel to view D_clock measurements</div>';
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/timing/clock-offset?channel=${encodeURIComponent(selectedChannel)}&hours=${hours}`);
                const data = await response.json();
                
                if (!data.available || !data.measurements || data.measurements.length === 0) {
                    chartDiv.innerHTML = `<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #94a3b8;">No D_clock data available for ${selectedChannel}</div>`;
                    if (statsDiv) statsDiv.innerHTML = '<div style="text-align: center; color: #94a3b8;">No data</div>';
                    return;
                }
                
                const gradeColors = { 'A': '#22c55e', 'B': '#3b82f6', 'C': '#eab308', 'D': '#f97316', 'X': '#ef4444' };
                
                // Build main D_clock trace
                const x = data.measurements.map(m => new Date(m.timestamp));
                const y = data.measurements.map(m => m.d_clock_ms);
                const colors = data.measurements.map(m => gradeColors[m.quality_grade] || '#64748b');
                const hoverText = data.measurements.map(m => 
                    `D_clock: ${m.d_clock_ms >= 0 ? '+' : ''}${m.d_clock_ms.toFixed(3)} ms<br>` +
                    `Grade: ${m.quality_grade}<br>` +
                    `Station: ${m.station}<br>` +
                    `Mode: ${m.propagation_mode || 'N/A'}<br>` +
                    `Confidence: ${(m.confidence * 100).toFixed(0)}%`
                );
                
                const traces = [{
                    x: x,
                    y: y,
                    mode: 'lines+markers',
                    name: 'D_clock',
                    line: { color: '#3b82f6', width: 2 },
                    marker: { 
                        size: 8, 
                        color: colors,
                        line: { color: '#fff', width: 1 }
                    },
                    hovertext: hoverText,
                    hoverinfo: 'text+x'
                }];
                
                // Add uncertainty band if available
                const hasUncertainty = data.measurements.some(m => m.uncertainty_ms !== null);
                if (hasUncertainty) {
                    const yUpper = data.measurements.map(m => m.d_clock_ms + (m.uncertainty_ms || 0));
                    const yLower = data.measurements.map(m => m.d_clock_ms - (m.uncertainty_ms || 0));
                    
                    traces.push({
                        x: [...x, ...x.slice().reverse()],
                        y: [...yUpper, ...yLower.reverse()],
                        fill: 'toself',
                        fillcolor: 'rgba(59, 130, 246, 0.1)',
                        line: { color: 'transparent' },
                        name: 'Uncertainty',
                        showlegend: false,
                        hoverinfo: 'skip'
                    });
                }
                
                const layout = {
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    margin: { l: 60, r: 30, t: 20, b: 50 },
                    xaxis: {
                        gridcolor: '#334155',
                        tickcolor: '#64748b',
                        tickfont: { color: '#94a3b8' },
                        title: { text: 'Time (UTC)', font: { color: '#94a3b8', size: 12 } }
                    },
                    yaxis: {
                        gridcolor: '#334155',
                        tickcolor: '#64748b',
                        tickfont: { color: '#94a3b8' },
                        title: { text: 'D_clock (ms)', font: { color: '#94a3b8', size: 12 } },
                        zeroline: true,
                        zerolinecolor: '#94a3b8',
                        zerolinewidth: 1
                    },
                    legend: {
                        font: { color: '#e0e0e0' },
                        bgcolor: 'rgba(30, 41, 59, 0.8)'
                    },
                    hovermode: 'closest'
                };
                
                Plotly.newPlot(chartDiv, traces, layout, { responsive: true, displayModeBar: false });
                
                // Update stats display
                if (statsDiv && data.statistics) {
                    const stats = data.statistics;
                    const gradeDistHtml = Object.entries(data.grade_distribution || {})
                        .map(([grade, count]) => `<span style="color: ${gradeColors[grade] || '#64748b'};">${grade}: ${count}</span>`)
                        .join(' | ');
                    
                    statsDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 13px; color: #94a3b8;">Mean</div>
                            <div style="font-size: 18px; font-weight: 600; color: #e0e0e0;">${stats.mean_ms} ms</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 13px; color: #94a3b8;">Std Dev</div>
                            <div style="font-size: 18px; font-weight: 600; color: #e0e0e0;">¬±${stats.std_ms} ms</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 13px; color: #94a3b8;">Range</div>
                            <div style="font-size: 18px; font-weight: 600; color: #e0e0e0;">${stats.min_ms} to ${stats.max_ms}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 13px; color: #94a3b8;">Samples</div>
                            <div style="font-size: 18px; font-weight: 600; color: #e0e0e0;">${data.count}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 13px; color: #94a3b8;">Grades</div>
                            <div style="font-size: 14px; font-weight: 500;">${gradeDistHtml}</div>
                        </div>
                    `;
                }
                
            } catch (err) {
                console.error('Failed to load D_clock chart:', err);
                chartDiv.innerHTML = `<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #ef4444;">Error loading D_clock data: ${err.message}</div>`;
            }
        }
        
        async function loadDriftChart() {
            const channelSelect = document.getElementById('drift-channel-select');
            const hoursSelect = document.getElementById('drift-hours-select');
            const chartDiv = document.getElementById('drift-chart');
            
            if (!chartDiv) return;
            
            const hours = hoursSelect ? parseInt(hoursSelect.value) : 24;
            const selectedChannel = channelSelect ? channelSelect.value : 'all';
            const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
            
            try {
                // Fetch metrics for all channels or selected channel
                const channelsToFetch = selectedChannel === 'all' ? availableChannels : [selectedChannel];
                const traces = [];
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'];
                
                for (let i = 0; i < channelsToFetch.length; i++) {
                    const channel = channelsToFetch[i];
                    try {
                        const response = await fetch(`/api/v1/timing/metrics?channel=${encodeURIComponent(channel)}&date=${today}&hours=${hours}`);
                        const data = await response.json();
                        
                        if (data.available && data.metrics && data.metrics.length > 0) {
                            const x = data.metrics.map(m => new Date(m.timestamp));
                            const y = data.metrics.map(m => m.drift_ms);
                            
                            traces.push({
                                x: x,
                                y: y,
                                mode: 'lines+markers',
                                name: channel,
                                line: { color: colors[i % colors.length], width: 2 },
                                marker: { size: 4 }
                            });
                        }
                    } catch (err) {
                        console.warn(`Failed to load drift data for ${channel}:`, err);
                    }
                }
                
                // Add reference bands
                const shapes = [
                    // Excellent band (¬±1ms)
                    { type: 'rect', xref: 'paper', yref: 'y', x0: 0, x1: 1, y0: -1, y1: 1,
                      fillcolor: 'rgba(16, 185, 129, 0.1)', line: { width: 0 } },
                    // Good band (¬±5ms)
                    { type: 'rect', xref: 'paper', yref: 'y', x0: 0, x1: 1, y0: -5, y1: -1,
                      fillcolor: 'rgba(59, 130, 246, 0.05)', line: { width: 0 } },
                    { type: 'rect', xref: 'paper', yref: 'y', x0: 0, x1: 1, y0: 1, y1: 5,
                      fillcolor: 'rgba(59, 130, 246, 0.05)', line: { width: 0 } }
                ];
                
                const layout = {
                    paper_bgcolor: '#0f172a',
                    plot_bgcolor: '#0f172a',
                    font: { color: '#e0e0e0', size: 12 },
                    xaxis: { 
                        gridcolor: '#334155',
                        title: 'Time (UTC)',
                        tickformat: '%H:%M'
                    },
                    yaxis: { 
                        gridcolor: '#334155', 
                        title: 'Drift (ms)',
                        zeroline: true,
                        zerolinecolor: '#64748b',
                        zerolinewidth: 2
                    },
                    margin: { t: 30, r: 30, b: 50, l: 60 },
                    legend: { 
                        orientation: 'h', 
                        y: -0.15,
                        font: { size: 10 }
                    },
                    shapes: shapes,
                    hovermode: 'x unified'
                };
                
                if (traces.length === 0) {
                    chartDiv.innerHTML = '<div style="text-align: center; padding: 60px; color: #94a3b8;">No drift data available for selected time range</div>';
                } else {
                    Plotly.newPlot('drift-chart', traces, layout, {responsive: true});
                }
                
            } catch (error) {
                console.error('Error loading drift chart:', error);
                chartDiv.innerHTML = `<div style="text-align: center; padding: 60px; color: #ef4444;">Failed to load drift data: ${error.message}</div>`;
            }
        }
        
        async function loadTimelineChart() {
            const hoursSelect = document.getElementById('timeline-hours-select');
            const chartDiv = document.getElementById('timeline-chart');
            
            if (!chartDiv) return;
            
            const hours = hoursSelect ? parseInt(hoursSelect.value) : 24;
            const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
            
            try {
                // Fetch metrics for all channels to build timeline
                const traces = [];
                const qualityColors = {
                    'TONE_LOCKED': '#10b981',
                    'TONE_STABLE': '#22c55e',
                    'TONE_AGED': '#f59e0b',
                    'NTP_SYNCED': '#3b82f6',
                    'INTERPOLATED': '#f59e0b',  // Legacy name
                    'WALL_CLOCK': '#ef4444'
                };
                
                for (let i = 0; i < availableChannels.length; i++) {
                    const channel = availableChannels[i];
                    try {
                        const response = await fetch(`/api/v1/timing/metrics?channel=${encodeURIComponent(channel)}&date=${today}&hours=${hours}`);
                        const data = await response.json();
                        
                        if (data.available && data.metrics && data.metrics.length > 0) {
                            // Group consecutive records by quality
                            const segments = [];
                            let currentSegment = null;
                            
                            for (const m of data.metrics) {
                                if (!currentSegment || currentSegment.quality !== m.quality) {
                                    if (currentSegment) {
                                        currentSegment.end = new Date(m.timestamp);
                                        segments.push(currentSegment);
                                    }
                                    currentSegment = {
                                        quality: m.quality,
                                        start: new Date(m.timestamp),
                                        end: null
                                    };
                                }
                            }
                            if (currentSegment) {
                                currentSegment.end = new Date();
                                segments.push(currentSegment);
                            }
                            
                            // Create a trace for each quality type for this channel
                            for (const quality of Object.keys(qualityColors)) {
                                const qualitySegments = segments.filter(s => s.quality === quality);
                                if (qualitySegments.length > 0) {
                                    for (const seg of qualitySegments) {
                                        traces.push({
                                            x: [seg.start, seg.end],
                                            y: [channel, channel],
                                            mode: 'lines',
                                            line: { color: qualityColors[quality], width: 20 },
                                            name: quality,
                                            legendgroup: quality,
                                            showlegend: traces.filter(t => t.legendgroup === quality).length === 0,
                                            hovertemplate: `${channel}<br>${quality}<br>%{x}<extra></extra>`
                                        });
                                    }
                                }
                            }
                        }
                    } catch (err) {
                        console.warn(`Failed to load timeline data for ${channel}:`, err);
                    }
                }
                
                // Calculate the time range for the X-axis to show full span
                const now = new Date();
                const rangeEnd = now;
                const rangeStart = new Date(now.getTime() - hours * 60 * 60 * 1000);
                
                const layout = {
                    paper_bgcolor: '#0f172a',
                    plot_bgcolor: '#0f172a',
                    font: { color: '#e0e0e0', size: 12 },
                    xaxis: { 
                        gridcolor: '#334155',
                        title: 'Time (UTC)',
                        tickformat: '%H:%M',
                        range: [rangeStart, rangeEnd]
                    },
                    yaxis: { 
                        gridcolor: '#334155',
                        title: '',
                        automargin: true
                    },
                    margin: { t: 30, r: 30, b: 50, l: 120 },
                    legend: { 
                        orientation: 'h', 
                        y: -0.12,
                        font: { size: 11 }
                    },
                    hovermode: 'closest',
                    barmode: 'overlay'
                };
                
                if (traces.length === 0) {
                    chartDiv.innerHTML = '<div style="text-align: center; padding: 60px; color: #94a3b8;">No timeline data available for selected time range</div>';
                } else {
                    Plotly.newPlot('timeline-chart', traces, layout, {responsive: true});
                }
                
            } catch (error) {
                console.error('Error loading timeline chart:', error);
                chartDiv.innerHTML = `<div style="text-align: center; padding: 60px; color: #ef4444;">Failed to load timeline data: ${error.message}</div>`;
            }
        }
        
        function checkAlerts(primaryRef, healthSummary, gpsdoStatus) {
            const banner = document.getElementById('alert-banner');
            const title = document.getElementById('alert-title');
            const message = document.getElementById('alert-message');
            
            const avgDrift = parseFloat(healthSummary.drift.average_ms);
            const isToneBased = primaryRef.is_tone_based || 
                               primaryRef.source_type?.includes('startup') ||
                               primaryRef.source_type?.includes('wwv') ||
                               primaryRef.source_type?.includes('chu');
            
            // Check GPSDO status first - highest priority alerts
            if (gpsdoStatus && gpsdoStatus.available) {
                if (gpsdoStatus.anchor_state === 'REANCHOR_REQUIRED') {
                    banner.className = 'alert-banner visible';
                    title.textContent = 'Critical: GPSDO Re-anchor Required';
                    message.textContent = 'Discontinuity detected in sample stream. Fresh anchor being established...';
                    return;
                }
                
                if (gpsdoStatus.anchor_state === 'HOLDOVER') {
                    banner.className = 'alert-banner visible warning';
                    title.textContent = 'Warning: GPSDO in Holdover';
                    message.textContent = `Drift alarm triggered - data being flagged. GPSDO may have lost lock.`;
                    return;
                }
            }
            
            // Check for critical issues
            if (!primaryRef.available) {
                banner.className = 'alert-banner visible';
                title.textContent = 'Critical: No Time Reference';
                message.textContent = 'No time reference available. Check core recorder and tone detection.';
                return;
            }
            
            // Wall clock with no tone history is critical
            if (primaryRef.quality === 'WALL_CLOCK' && !isToneBased) {
                banner.className = 'alert-banner visible';
                title.textContent = 'Critical: Using Unsynchronized Clock';
                message.textContent = 'No tone reference established. Timing precision is ¬±seconds. Check propagation and tone detection.';
                return;
            }
            
            // Excessive drift is always critical regardless of source
            if (avgDrift > 50) {
                banner.className = 'alert-banner visible';
                title.textContent = 'Critical: Excessive Drift';
                message.textContent = `Average drift is ${healthSummary.drift.average_ms}ms. Check system clock and RTP streams.`;
                return;
            }
            
            // Tone-based timing with good drift - no warning needed!
            // This was the key missing case
            if (isToneBased && avgDrift < 5) {
                // No alert - everything is working well
                banner.className = 'alert-banner';
                return;
            }
            
            // NTP-only with no tone-based channels is a soft warning
            if (!isToneBased && healthSummary.tone_locked_channels === 0) {
                banner.className = 'alert-banner visible warning';
                title.textContent = 'Info: Using NTP Timing';
                message.textContent = `All channels using NTP (¬±10ms). No tone detected yet - normal during poor propagation. RTP drift: ¬±${avgDrift.toFixed(2)}ms`;
                return;
            }
            
            // System stabilizing after startup
            if (primaryRef.age_seconds < 120) {
                banner.className = 'alert-banner visible warning';
                title.textContent = 'Info: System Stabilizing';
                message.textContent = 'Recently started - timing measurements stabilizing. Data quality will improve.';
                return;
            }
            
            // No critical alerts
            banner.className = 'alert-banner';
        }
        
        function formatAge(seconds) {
            if (seconds < 0) return '0s';
            const s = Math.floor(seconds);
            if (s < 60) return `${s}s`;
            if (s < 3600) return `${Math.floor(s/60)}m ${s%60}s`;
            return `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m`;
        }
        
        // Initialize
        loadDashboard();
        startAutoRefresh();
    </script>
    </div><!-- end container -->
    <script src="/utils/utc-time.js"></script>
    <script src="/components/theme-toggle.js"></script>
    <script src="/components/navigation.js"></script>
</body>
</html>
