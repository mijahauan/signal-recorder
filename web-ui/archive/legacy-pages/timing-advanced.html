<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAPE - Advanced Timing Visualizations</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script>window.GRAPE_CURRENT_PAGE = 'timing-advanced';</script>
    <script src="components/navigation.js"></script>
    <script src="components/timing-visualizations.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        .page-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #334155;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .page-title span {
            font-size: 28px;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .status-badge.loading {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }
        
        .viz-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .viz-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .viz-panel {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }
        
        .viz-panel.full-width {
            grid-column: 1 / -1;
        }
        
        .viz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .viz-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .viz-title span {
            font-size: 20px;
        }
        
        .viz-subtitle {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .info-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            font-size: 11px;
            font-weight: 700;
            text-decoration: none;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .info-link:hover {
            background: #3b82f6;
            color: #fff;
        }
        
        .viz-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .viz-controls select,
        .viz-controls input {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 6px 12px;
            color: #e0e0e0;
            font-size: 13px;
        }
        
        .viz-controls button {
            background: #3b82f6;
            border: none;
            border-radius: 6px;
            padding: 6px 14px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .viz-controls button:hover {
            background: #2563eb;
        }
        
        .chart-container {
            height: 350px;
            position: relative;
        }
        
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #64748b;
            font-size: 14px;
        }
        
        .legend-row {
            display: flex;
            gap: 20px;
            margin-top: 12px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 12px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-links a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 13px;
            transition: color 0.2s;
        }
        
        .nav-links a:hover {
            color: #3b82f6;
        }
        
        .info-tooltip {
            position: relative;
            cursor: help;
            color: #64748b;
        }
        
        .info-tooltip:hover::after {
            content: attr(data-info);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            border: 1px solid #475569;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #e0e0e0;
            white-space: nowrap;
            z-index: 100;
        }
        
        .state-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .state-indicator.locked {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .state-indicator.converging {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .state-indicator.split {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
        }
        
        .state-indicator.unknown {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Unified Navigation -->
        <div id="grape-navigation"></div>
        
        <div class="page-header">
            <div class="page-title">
                <span>üî¨</span>
                <div>
                    Advanced Timing Visualizations
                    <div class="viz-subtitle">Scientific analysis of UTC(NIST) convergence</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div id="status-badge" class="status-badge loading">
                    <div style="width: 8px; height: 8px; background: currentColor; border-radius: 50%;"></div>
                    Loading...
                </div>
            </div>
        </div>
        
        <div class="viz-grid">
            <!-- Kalman Funnel Chart -->
            <div class="viz-panel full-width">
                <div class="viz-header">
                    <div class="viz-title">
                        <span>üéØ</span>
                        <div>
                            Clock Stability Convergence
                            <a href="/docs/timing-methodology.html#kalman-funnel" class="info-link" title="How this works">?</a>
                            <div class="viz-subtitle">Fusion-corrected D_clock converging to UTC(NIST)</div>
                        </div>
                    </div>
                    <div class="viz-controls">
                        <select id="funnel-minutes">
                            <option value="60">Last 1 hour</option>
                            <option value="120">Last 2 hours</option>
                            <option value="360">Last 6 hours</option>
                            <option value="720">Last 12 hours</option>
                            <option value="1440" selected>Last 24 hours</option>
                        </select>
                        <button onclick="loadKalmanFunnel()">Refresh</button>
                        <span style="font-size: 11px; color: #64748b; margin-left: 10px;">Drag to zoom, double-click to reset</span>
                    </div>
                </div>
                <div class="chart-container" id="kalman-funnel-chart">
                    <div class="chart-loading">Loading clock stability data...</div>
                </div>
                <div class="legend-row">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: rgba(59, 130, 246, 0.5);"></div>
                        <span>Locked (low uncertainty)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: rgba(148, 163, 184, 0.5);"></div>
                        <span>Hold (high uncertainty)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #ef4444;"></div>
                        <span>Anomaly (outside bounds)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #22c55e;"></div>
                        <span>UTC Reference (0 ms)</span>
                    </div>
                </div>
            </div>
            
            <!-- Constellation Radar -->
            <div class="viz-panel">
                <div class="viz-header">
                    <div class="viz-title">
                        <span>üõ∞Ô∏è</span>
                        <div>
                            Station Constellation
                            <a href="/docs/timing-methodology.html#constellation" class="info-link" title="How this works">?</a>
                            <div class="viz-subtitle">Timing error by azimuth (center = perfect)</div>
                        </div>
                    </div>
                    <div class="viz-controls">
                        <button onclick="loadConstellation()">Refresh</button>
                    </div>
                </div>
                <div class="chart-container" id="constellation-chart">
                    <div class="chart-loading">Loading constellation data...</div>
                </div>
                <div class="legend-row">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #22c55e;"></div>
                        <span>&lt;1ms (Good)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #eab308;"></div>
                        <span>1-5ms (Fair)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #ef4444;"></div>
                        <span>&gt;5ms (Multipath)</span>
                    </div>
                </div>
            </div>
            
            <!-- Probability Peak (KDE) -->
            <div class="viz-panel">
                <div class="viz-header">
                    <div class="viz-title">
                        <span>üìà</span>
                        <div>
                            Consensus Time Distribution
                            <a href="/docs/timing-methodology.html#consensus" class="info-link" title="How this works">?</a>
                            <div class="viz-subtitle">KDE showing agreement across stations</div>
                        </div>
                    </div>
                    <div id="consensus-state" class="state-indicator unknown">
                        Unknown
                    </div>
                </div>
                <div class="chart-container" id="probability-peak-chart">
                    <div class="chart-loading">Loading consensus data...</div>
                </div>
                <div class="legend-row">
                    <div class="legend-item">
                        <span style="color: #22c55e;">Sharp Peak</span>
                        <span style="color: #64748b;">= All stations agree</span>
                    </div>
                    <div class="legend-item">
                        <span style="color: #f97316;">Double Hump</span>
                        <span style="color: #64748b;">= Mode ambiguity</span>
                    </div>
                </div>
            </div>
            
            <!-- Mode Probability Ridge -->
            <div class="viz-panel full-width">
                <div class="viz-header">
                    <div class="viz-title">
                        <span>üåä</span>
                        <div>
                            Propagation Mode Probability
                            <a href="/docs/timing-methodology.html#propagation" class="info-link" title="How this works">?</a>
                            <div class="viz-subtitle">Ionospheric hop identification</div>
                        </div>
                    </div>
                    <div class="viz-controls">
                        <select id="mode-channel">
                            <option value="">Best available</option>
                        </select>
                        <button onclick="loadModeProbability()">Refresh</button>
                    </div>
                </div>
                <div class="chart-container" id="mode-ridge-chart">
                    <div class="chart-loading">Loading propagation mode data...</div>
                </div>
                <div class="legend-row">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #22c55e;"></div>
                        <span>High probability (&gt;70%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #3b82f6;"></div>
                        <span>Medium (40-70%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #eab308;"></div>
                        <span>Low (20-40%)</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 20px; height: 3px; background: #f43f5e;"></div>
                        <span>Measured arrival time</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Chart instances
        let kalmanChart = null;
        let constellationChart = null;
        let probabilityChart = null;
        let modeChart = null;
        
        // Fusion calibration for correcting D_clock values
        let fusionCalibration = null;
        
        // Auto-refresh interval
        let refreshInterval = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadAllCharts();
            populateChannelDropdown();
            
            // Auto-refresh every 30 seconds
            refreshInterval = setInterval(loadAllCharts, 30000);
        });
        
        // Apply fusion calibration correction to a D_clock value
        function applyFusionCorrection(offset_ms, station) {
            if (!fusionCalibration || !station || !fusionCalibration[station]) {
                return offset_ms;  // Return uncorrected if no calibration
            }
            // Add calibration offset to bring value toward 0 (UTC aligned)
            return offset_ms + fusionCalibration[station].offset_ms;
        }
        
        async function loadFusionCalibration() {
            try {
                const response = await fetch('/api/v1/timing/fusion');
                const data = await response.json();
                if (data.status === 'active' && data.calibration) {
                    fusionCalibration = data.calibration;
                }
            } catch (err) {
                console.error('Error loading fusion calibration:', err);
            }
        }
        
        async function loadAllCharts() {
            updateStatus('loading');
            
            try {
                // Load fusion calibration first, then apply to all charts
                await loadFusionCalibration();
                
                await Promise.all([
                    loadKalmanFunnel(),
                    loadConstellation(),
                    loadProbabilityPeak(),
                    loadModeProbability()
                ]);
                updateStatus('live');
            } catch (err) {
                console.error('Error loading charts:', err);
                updateStatus('error');
            }
        }
        
        function updateStatus(state) {
            const badge = document.getElementById('status-badge');
            if (state === 'loading') {
                badge.className = 'status-badge loading';
                badge.innerHTML = '<div style="width: 8px; height: 8px; background: currentColor; border-radius: 50%;"></div> Loading...';
            } else if (state === 'live') {
                badge.className = 'status-badge';
                badge.innerHTML = '<div style="width: 8px; height: 8px; background: currentColor; border-radius: 50%; animation: pulse 2s infinite;"></div> Live';
            } else {
                badge.className = 'status-badge';
                badge.style.background = 'rgba(239, 68, 68, 0.2)';
                badge.style.color = '#ef4444';
                badge.innerHTML = '<div style="width: 8px; height: 8px; background: currentColor; border-radius: 50%;"></div> Error';
            }
        }
        
        async function loadKalmanFunnel() {
            const container = document.getElementById('kalman-funnel-chart');
            const minutes = document.getElementById('funnel-minutes').value;
            
            try {
                // Use fusion API directly - it already computes the correctly fused d_clock
                const response = await fetch('/api/v1/timing/fusion');
                const fusionData = await response.json();
                
                if (!fusionData.history || fusionData.history.length === 0) {
                    container.innerHTML = '<div class="chart-loading">No fusion data available</div>';
                    return;
                }
                
                // Filter to requested time window
                const cutoffTime = Date.now() / 1000 - (parseInt(minutes) * 60);
                const filteredHistory = fusionData.history.filter(p => p.timestamp >= cutoffTime);
                
                // Convert fusion history to chart format
                const points = filteredHistory.map(p => ({
                    timestamp: p.timestamp,
                    offset_ms: p.d_clock_fused_ms,  // Use the FUSED value directly!
                    uncertainty_ms: p.uncertainty_ms || 1.0,
                    status: p.uncertainty_ms < 2.0 ? 'LOCKED' : 'HOLD',
                    channel: 'Fusion (13 broadcasts)',
                    station: 'FUSED'
                }));
                
                if (points.length === 0) {
                    container.innerHTML = '<div class="chart-loading">No data in selected time window</div>';
                    return;
                }
                
                if (!kalmanChart) {
                    kalmanChart = new KalmanFunnelChart('kalman-funnel-chart', {
                        timeWindowMinutes: parseInt(minutes),
                        yAxisRange: [-5, 5]  // Fused values should be near 0
                    });
                }
                
                kalmanChart.update(points);
            } catch (err) {
                console.error('Error loading Kalman funnel:', err);
                container.innerHTML = `<div class="chart-loading" style="color: #ef4444;">Error: ${err.message}</div>`;
            }
        }
        
        async function loadConstellation() {
            const container = document.getElementById('constellation-chart');
            
            try {
                // Always create the chart (shows vectors even without data)
                if (!constellationChart) {
                    constellationChart = new ConstellationRadar('constellation-chart', {
                        maxRadius: 3  // Narrower range - calibrated values should be near 0
                    });
                }
                
                // Get fusion data for calibration offsets
                const fusionResponse = await fetch('/api/v1/timing/fusion');
                const fusionData = await fusionResponse.json();
                const calibration = fusionData.calibration || {};
                
                const response = await fetch('/api/v1/timing/constellation');
                const data = await response.json();
                
                // Apply calibration directly from fusion data
                if (data && data.stations) {
                    data.stations = data.stations.map(st => {
                        const stationCal = calibration[st.base_station];
                        const calOffset = stationCal ? stationCal.offset_ms : 0;
                        return {
                            ...st,
                            error_ms: st.error_ms + calOffset  // Apply calibration
                        };
                    });
                }
                
                // Update with data (or empty - vectors still show)
                constellationChart.update(data || { stations: [] });
            } catch (err) {
                console.error('Error loading constellation:', err);
                // Still render with empty data to show vectors
                if (constellationChart) {
                    constellationChart.update({ stations: [] });
                }
            }
        }
        
        async function loadProbabilityPeak() {
            const container = document.getElementById('probability-peak-chart');
            const stateIndicator = document.getElementById('consensus-state');
            
            try {
                // Use fusion API - it has the correctly fused values
                const response = await fetch('/api/v1/timing/fusion');
                const fusionData = await response.json();
                
                if (!fusionData.history || fusionData.history.length === 0) {
                    container.innerHTML = '<div class="chart-loading">No fusion data available</div>';
                    stateIndicator.className = 'state-indicator unknown';
                    stateIndicator.textContent = 'No Data';
                    return;
                }
                
                // Get recent fusion values (last 10 minutes)
                const cutoffTime = Date.now() / 1000 - 600;
                const recentHistory = fusionData.history.filter(p => p.timestamp >= cutoffTime);
                
                // Check consensus state based on uncertainty spread
                const uncertainties = recentHistory.map(p => p.uncertainty_ms || 3);
                const avgUncertainty = uncertainties.reduce((a, b) => a + b, 0) / uncertainties.length;
                const state = avgUncertainty < 2 ? 'LOCKED' : avgUncertainty < 4 ? 'CONVERGING' : 'DIVERGENT';
                
                // Update state indicator
                const stateClasses = {
                    'LOCKED': 'locked',
                    'CONVERGING': 'converging',
                    'DIVERGENT': 'split'
                };
                const stateLabels = {
                    'LOCKED': '‚úì Locked',
                    'CONVERGING': '‚óê Converging',
                    'DIVERGENT': '‚ö† Divergent'
                };
                stateIndicator.className = `state-indicator ${stateClasses[state] || 'unknown'}`;
                stateIndicator.textContent = stateLabels[state] || state;
                
                // Convert fusion history to estimates format for KDE
                // Use FUSED d_clock values - already correct!
                const estimates = recentHistory.map(p => ({
                    offset: p.d_clock_fused_ms,  // Use fused value directly
                    uncertainty: p.uncertainty_ms || 1.0,
                    station: 'FUSED',
                    weight: 1.0
                }));
                
                if (!probabilityChart) {
                    probabilityChart = new ProbabilityPeak('probability-peak-chart', {
                        xRange: [-3, 3],  // Fused values should be near 0
                        bandwidth: 0.3
                    });
                }
                
                probabilityChart.update(estimates);
            } catch (err) {
                console.error('Error loading probability peak:', err);
                container.innerHTML = `<div class="chart-loading" style="color: #ef4444;">Error: ${err.message}</div>`;
            }
        }
        
        async function loadModeProbability() {
            const container = document.getElementById('mode-ridge-chart');
            const channelSelect = document.getElementById('mode-channel');
            const channel = channelSelect.value;
            
            try {
                const url = channel 
                    ? `/api/v1/timing/mode-probability?channel=${encodeURIComponent(channel)}`
                    : '/api/v1/timing/mode-probability';
                    
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.available) {
                    container.innerHTML = '<div class="chart-loading">No propagation mode data available</div>';
                    return;
                }
                
                if (!modeChart) {
                    modeChart = new ModeProbabilityRidge('mode-ridge-chart', {
                        xRange: [0, 18]
                    });
                }
                
                modeChart.update(data);
            } catch (err) {
                console.error('Error loading mode probability:', err);
                container.innerHTML = `<div class="chart-loading" style="color: #ef4444;">Error: ${err.message}</div>`;
            }
        }
        
        async function populateChannelDropdown() {
            try {
                const response = await fetch('/api/v1/timing/health-summary');
                const data = await response.json();
                
                const select = document.getElementById('mode-channel');
                select.innerHTML = '<option value="">Best available</option>';
                
                if (data.channels) {
                    data.channels.forEach(ch => {
                        const option = document.createElement('option');
                        option.value = ch.channel;
                        option.textContent = ch.channel;
                        select.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('Error populating channel dropdown:', err);
            }
        }
        
        // Add pulse animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.5; transform: scale(0.9); }
            }
        `;
        document.head.appendChild(style);
    </script>
    <script src="components/theme-toggle.js"></script>
</body>
</html>
