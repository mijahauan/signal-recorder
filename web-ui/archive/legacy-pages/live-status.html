<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAPE Live Status - Multi-Station Tone Detection</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 {
            color: #4fc3f7;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 10px;
        }
        .refresh-info {
            color: #888;
            font-size: 14px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #2a2a2a;
            border: 1px solid #444;
        }
        th {
            background: #1a1a1a;
            color: #4fc3f7;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #4fc3f7;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #333;
        }
        tr:hover {
            background: #333;
        }
        .channel-name {
            color: #81c784;
            font-weight: 600;
        }
        .numeric {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .stations-badge {
            display: inline-block;
            background: #1976d2;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }
        .error {
            background: #c62828;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .timestamp {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <h1>üéôÔ∏è GRAPE Live Status - Multi-Station Tone Detection</h1>
    <div class="refresh-info">Auto-refreshes at :15 seconds of each minute</div>
    
    <div class="error" style="background: #1a3a5a; border-color: #4fc3f7;">
        <strong>üìä Column Descriptions:</strong><br>
        <strong>Sync:</strong> Time reference state - "active" = RTP-based time_snap timing (accurate), "startup" = wall clock (inaccurate)<br>
        <strong>Stations:</strong> Active stations detected (WWV/WWVH/CHU)<br>
        <strong>Rate:</strong> Detection success rate (detections/expected)<br>
        <strong>WWV/WWVH/CHU:</strong> Individual station detection counts<br>
        <strong>Total:</strong> Total primary timing detections (WWV + CHU)<br>
        <strong>Timing Error:</strong> Measured offset from :00.000 UTC (mean ¬± std). Should be <50ms when Sync=active.<br>
        <strong>WWV-WWVH Differential:</strong> Path delay difference between WWV and WWVH (ionospheric propagation study)
    </div>
    
    <div id="content">
        <p>Loading...</p>
    </div>
    
    <div class="timestamp" id="timestamp"></div>

    <script>
        async function fetchStatus() {
            try {
                const response = await fetch('/api/monitoring/live-quality');
                const data = await response.json();
                
                if (!data.available) {
                    document.getElementById('content').innerHTML = `
                        <div class="error">
                            <strong>‚ùå Recorder not running or no data available</strong><br>
                            ${data.message || 'Unknown error'}
                        </div>
                    `;
                    return;
                }
                
                const timing = data.timing_detections || {};
                const channels = Object.keys(timing);
                
                if (channels.length === 0) {
                    document.getElementById('content').innerHTML = `
                        <div class="error">
                            <strong>‚è≥ Waiting for tone detections...</strong><br>
                            Detections occur at the top of each minute (:00 seconds)
                        </div>
                    `;
                    return;
                }
                
                // Get full status for sync_state
                const fullStatus = data.status || {};
                const recorders = fullStatus.recorders || {};
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th>Sync</th>
                                <th>Stations</th>
                                <th class="numeric">Rate</th>
                                <th class="numeric">WWV</th>
                                <th class="numeric">WWVH</th>
                                <th class="numeric">CHU</th>
                                <th class="numeric">Total</th>
                                <th class="numeric">Timing Error<br>(mean ¬± std)</th>
                                <th class="numeric">WWV-WWVH<br>Differential</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Sort channels for better display (WWV first, then CHU)
                channels.sort((a, b) => {
                    if (a.startsWith('WWV') && b.startsWith('CHU')) return -1;
                    if (a.startsWith('CHU') && b.startsWith('WWV')) return 1;
                    return a.localeCompare(b);
                });
                
                channels.forEach(channel => {
                    const ch = timing[channel];
                    const channelName = channel === 'undefined' ? '(Channel name pending)' : channel;
                    const stationBadges = (ch.stations_active || [])
                        .map(s => `<span class="stations-badge">${s}</span>`)
                        .join('');
                    
                    // Find recorder by channel name to get sync_state
                    let syncState = 'unknown';
                    let syncColor = '#666';
                    for (const [ssrc, rec] of Object.entries(recorders)) {
                        if (rec.channel_name === channel) {
                            syncState = rec.sync_state || 'unknown';
                            syncColor = syncState === 'active' ? '#81c784' : '#ffb74d';
                            break;
                        }
                    }
                    
                    const detectionRate = (ch.detection_rate * 100).toFixed(0);
                    const rateColor = detectionRate >= 80 ? '#81c784' : detectionRate >= 50 ? '#ffb74d' : '#e57373';
                    
                    const timingError = ch.timing_error_mean_ms !== 0 
                        ? `${ch.timing_error_mean_ms > 0 ? '+' : ''}${ch.timing_error_mean_ms.toFixed(1)} ¬± ${ch.timing_error_std_ms.toFixed(1)} ms`
                        : '-';
                    
                    const differential = ch.differential_mean_ms !== 0
                        ? `${ch.differential_mean_ms > 0 ? '+' : ''}${ch.differential_mean_ms.toFixed(1)} ¬± ${ch.differential_std_ms.toFixed(1)} ms`
                        : '-';
                    
                    html += `
                        <tr>
                            <td class="channel-name">${channelName}</td>
                            <td style="color: ${syncColor}; font-weight: bold;">${syncState}</td>
                            <td>${stationBadges || '<span style="color:#666">-</span>'}</td>
                            <td class="numeric" style="color: ${rateColor}; font-weight: bold;">${detectionRate}%</td>
                            <td class="numeric">${ch.wwv_detections}</td>
                            <td class="numeric">${ch.wwvh_detections}</td>
                            <td class="numeric">${ch.chu_detections}</td>
                            <td class="numeric" style="font-weight: bold;">${ch.total_detections}</td>
                            <td class="numeric">${timingError}</td>
                            <td class="numeric">${differential}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                document.getElementById('content').innerHTML = html;
                document.getElementById('timestamp').textContent = 
                    `Last updated: ${new Date(data.timestamp).toLocaleString()}`;
                
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Error loading data</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        // Schedule refresh at :15 seconds of each minute
        function scheduleRefreshes() {
            // Fetch immediately on page load
            fetchStatus();
            
            // Calculate milliseconds until next :15 mark
            const now = new Date();
            const seconds = now.getSeconds();
            const milliseconds = now.getMilliseconds();
            
            // Time until next :15 (or :15 + 60, 120, etc.)
            let secondsUntil15;
            if (seconds < 15) {
                secondsUntil15 = 15 - seconds;
            } else {
                secondsUntil15 = 75 - seconds; // Next minute's :15
            }
            
            const msUntil15 = (secondsUntil15 * 1000) - milliseconds;
            
            console.log(`Next refresh in ${(msUntil15/1000).toFixed(1)} seconds at :15`);
            
            // Wait until :15, then refresh every 60 seconds
            setTimeout(() => {
                fetchStatus();
                // Now refresh every 60 seconds at :15
                setInterval(fetchStatus, 60000);
            }, msUntil15);
        }
        
        scheduleRefreshes();
    </script>
</body>
</html>
