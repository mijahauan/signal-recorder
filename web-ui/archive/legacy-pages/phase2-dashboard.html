<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 Analysis - GRAPE Signal Recorder</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        window.GRAPE_CURRENT_PAGE = 'phase2';
    </script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --border-color: #475569;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header h1 .icon { font-size: 1.5rem; }
        
        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .btn:hover { background: var(--bg-tertiary); }
        .btn-primary { background: var(--accent-blue); border-color: var(--accent-blue); }
        .btn-primary:hover { background: #2563eb; }
        
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--accent-green);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--accent-green);
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .panel {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .panel-full { grid-column: 1 / -1; }
        
        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .panel-content {
            padding: 20px;
        }
        
        /* Station-Channel Matrix */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .matrix-table th, .matrix-table td {
            padding: 12px 16px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .matrix-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .matrix-table th:first-child,
        .matrix-table td:first-child {
            text-align: left;
            font-weight: 500;
        }
        
        .matrix-table tr:hover { background: rgba(59, 130, 246, 0.05); }
        
        .signal-strength {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .signal-dots {
            display: flex;
            gap: 2px;
        }
        
        .signal-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-tertiary);
        }
        
        .signal-dot.active { background: var(--accent-green); }
        .signal-dot.active.medium { background: var(--accent-yellow); }
        .signal-dot.active.weak { background: var(--accent-red); }
        
        .signal-value {
            font-size: 0.75rem;
            color: var(--text-secondary);
            min-width: 40px;
        }
        
        .station-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .station-wwv { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .station-wwvh { background: rgba(168, 85, 247, 0.2); color: var(--accent-purple); }
        .station-chu { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .station-none { background: var(--bg-tertiary); color: var(--text-secondary); }
        
        /* D_clock Consensus */
        .consensus-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .consensus-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .consensus-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .consensus-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .broadcast-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 6px;
        }
        
        .broadcast-name {
            width: 120px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .broadcast-bar-container {
            flex: 1;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .broadcast-bar {
            position: absolute;
            height: 100%;
            background: var(--accent-blue);
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .broadcast-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--text-primary);
            border-radius: 2px;
            transform: translateX(-50%);
        }
        
        .broadcast-value {
            width: 100px;
            text-align: right;
            font-size: 0.8rem;
            font-family: 'Monaco', monospace;
        }
        
        .broadcast-status {
            width: 24px;
            text-align: center;
        }
        
        /* Diurnal Pattern */
        .diurnal-chart {
            height: 200px;
            position: relative;
        }
        
        .diurnal-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .diurnal-label {
            width: 80px;
            font-size: 0.8rem;
            text-align: right;
        }
        
        .diurnal-bar {
            flex: 1;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            display: flex;
            overflow: hidden;
        }
        
        .diurnal-segment {
            height: 100%;
            transition: width 0.3s;
        }
        
        .diurnal-segment.wwv { background: var(--accent-blue); }
        .diurnal-segment.wwvh { background: var(--accent-purple); }
        .diurnal-segment.mixed { background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); }
        .diurnal-segment.none { background: var(--bg-tertiary); }
        
        .diurnal-time-axis {
            display: flex;
            justify-content: space-between;
            margin-left: 92px;
            margin-top: 8px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        /* Geographic View */
        .geo-container {
            display: flex;
            gap: 20px;
        }
        
        .geo-paths {
            flex: 1;
        }
        
        .geo-path {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .geo-station {
            width: 100px;
            font-weight: 600;
        }
        
        .geo-details {
            flex: 1;
            display: flex;
            gap: 20px;
            font-size: 0.8rem;
        }
        
        .geo-detail {
            display: flex;
            flex-direction: column;
        }
        
        .geo-detail-label {
            color: var(--text-secondary);
            font-size: 0.7rem;
        }
        
        .geo-detail-value {
            font-weight: 500;
        }
        
        .geo-signal {
            width: 80px;
            text-align: right;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.75rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-secondary);
        }
        
        .nav-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 0.875rem;
        }
        
        .nav-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div id="grape-navigation"></div>
    <div class="dashboard" style="margin-top: 70px;">
        <div class="header">
            <div>
                <h1><span class="icon">üì°</span> Phase 2 Analysis Dashboard</h1>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 4px;">
                    9 Channels ‚Ä¢ 13 Broadcasts ‚Ä¢ 3 Stations
                </p>
            </div>
            <div class="header-controls">
                <a href="index.html" class="nav-link">‚Üê Back to Summary</a>
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span>Live</span>
                </div>
                <button class="btn btn-primary" onclick="refreshAll()">Refresh</button>
            </div>
        </div>
        
        <!-- Panel 1: Station-Channel Matrix -->
        <div class="panels">
            <div class="panel panel-full">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">üìä Station-Channel Reception Matrix</div>
                        <div class="panel-subtitle">Signal strength and discrimination status for all 13 broadcasts</div>
                    </div>
                    <span id="matrix-timestamp" style="font-size: 0.75rem; color: var(--text-secondary);"></span>
                </div>
                <div class="panel-content">
                    <table class="matrix-table" id="reception-matrix">
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th>WWV (Fort Collins, CO)</th>
                                <th>WWVH (Kauai, HI)</th>
                                <th>CHU (Ottawa, ON)</th>
                                <th>Dominant</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody id="matrix-body">
                            <tr><td colspan="6" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Panel 2: D_clock Consensus -->
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">üéØ D_clock Consensus</div>
                        <div class="panel-subtitle">UTC(NIST) recovery from all broadcasts</div>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="consensus-container" id="consensus-container">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Panel 3: Geographic Propagation -->
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">üåç Propagation Paths</div>
                        <div class="panel-subtitle">Great circle paths and ionospheric modes</div>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="geo-container" id="geo-container">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Panel 4: Diurnal Pattern -->
            <div class="panel panel-full">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">üìà Diurnal Station Dominance</div>
                        <div class="panel-subtitle">24-hour pattern of WWV vs WWVH reception by channel</div>
                    </div>
                </div>
                <div class="panel-content">
                    <div id="diurnal-chart">
                        <div class="loading">Loading...</div>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--accent-blue);"></div>
                            <span>WWV dominant</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--accent-purple);"></div>
                            <span>WWVH dominant</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));"></div>
                            <span>Mixed/Ambiguous</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const WWV_CHANNELS = ['WWV 2.5 MHz', 'WWV 5 MHz', 'WWV 10 MHz', 'WWV 15 MHz', 'WWV 20 MHz', 'WWV 25 MHz'];
        const CHU_CHANNELS = ['CHU 3.33 MHz', 'CHU 7.85 MHz', 'CHU 14.67 MHz'];
        const ALL_CHANNELS = [...WWV_CHANNELS, ...CHU_CHANNELS];
        
        // Helper functions
        function getSignalDots(snr) {
            if (snr === null || snr === undefined) return { dots: 0, class: '' };
            if (snr >= 30) return { dots: 4, class: '' };
            if (snr >= 20) return { dots: 3, class: '' };
            if (snr >= 10) return { dots: 2, class: 'medium' };
            if (snr > 0) return { dots: 1, class: 'weak' };
            return { dots: 0, class: '' };
        }
        
        function renderSignalStrength(snr, detected) {
            if (!detected && (snr === null || snr === undefined)) {
                return '<span style="color: var(--text-secondary);">‚Äî</span>';
            }
            
            const { dots, class: dotClass } = getSignalDots(snr);
            let html = '<div class="signal-strength"><div class="signal-dots">';
            for (let i = 0; i < 4; i++) {
                const activeClass = i < dots ? `active ${dotClass}` : '';
                html += `<div class="signal-dot ${activeClass}"></div>`;
            }
            html += '</div>';
            if (snr !== null && snr !== undefined) {
                html += `<span class="signal-value">${snr.toFixed(0)} dB</span>`;
            }
            html += '</div>';
            return html;
        }
        
        function renderStationBadge(station) {
            if (!station || station === 'NONE' || station === 'UNKNOWN') {
                return '<span class="station-badge station-none">‚Äî</span>';
            }
            const cls = station.toLowerCase().includes('wwvh') ? 'station-wwvh' : 
                       station.toLowerCase().includes('wwv') ? 'station-wwv' : 
                       station.toLowerCase().includes('chu') ? 'station-chu' : 'station-none';
            return `<span class="station-badge ${cls}">${station}</span>`;
        }
        
        // Load Reception Matrix
        async function loadReceptionMatrix() {
            const tbody = document.getElementById('matrix-body');
            try {
                const response = await fetch('/api/v1/phase2/reception-matrix');
                const data = await response.json();
                
                if (!data.channels || data.channels.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">No data available</td></tr>';
                    return;
                }
                
                let html = '';
                for (const ch of data.channels) {
                    const isWWV = ch.channel.startsWith('WWV');
                    const isCHU = ch.channel.startsWith('CHU');
                    const canReceiveWWVH = ch.canReceiveWWVH;
                    
                    // WWVH only broadcasts on 2.5, 5, 10, 15 MHz (not 20 or 25)
                    const wwvhCell = !isWWV ? '‚Äî' : 
                                     !canReceiveWWVH ? '<span style="color: var(--text-secondary); font-size: 0.75rem;">N/A</span>' :
                                     renderSignalStrength(ch.wwvh_snr_db, ch.wwvh_detected);
                    
                    html += `<tr>
                        <td><strong>${ch.channel}</strong></td>
                        <td>${isWWV ? renderSignalStrength(ch.wwv_snr_db, ch.wwv_detected) : '‚Äî'}</td>
                        <td>${wwvhCell}</td>
                        <td>${isCHU ? renderSignalStrength(ch.chu_snr_db, ch.chu_detected) : '‚Äî'}</td>
                        <td>${renderStationBadge(ch.dominant_station)}</td>
                        <td style="color: ${ch.confidence === 'high' ? 'var(--accent-green)' : ch.confidence === 'medium' ? 'var(--accent-yellow)' : 'var(--text-secondary)'}">
                            ${ch.confidence || '‚Äî'}
                        </td>
                    </tr>`;
                }
                tbody.innerHTML = html;
                
                document.getElementById('matrix-timestamp').textContent = 
                    `Updated: ${UTCTime.now()} UTC`;
            } catch (err) {
                console.error('Error loading reception matrix:', err);
                tbody.innerHTML = `<tr><td colspan="6" class="loading">Error: ${err.message}</td></tr>`;
            }
        }
        
        // Load D_clock Consensus
        async function loadConsensus() {
            const container = document.getElementById('consensus-container');
            try {
                const response = await fetch('/api/v1/phase2/dclock-consensus');
                const data = await response.json();
                
                let html = '';
                
                // Summary box
                html += `<div class="consensus-summary">
                    <div>
                        <div class="consensus-value">${data.consensus_ms !== null ? data.consensus_ms.toFixed(2) + ' ms' : '‚Äî'}</div>
                        <div class="consensus-label">Consensus D_clock</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.25rem; font-weight: 600;">${data.agreeing_count || 0}/${data.total_count || 0}</div>
                        <div class="consensus-label">Broadcasts agreeing</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.25rem; font-weight: 600;">¬±${data.uncertainty_ms ? data.uncertainty_ms.toFixed(2) : '‚Äî'} ms</div>
                        <div class="consensus-label">Uncertainty</div>
                    </div>
                </div>`;
                
                // Individual broadcasts
                if (data.broadcasts && data.broadcasts.length > 0) {
                    const minVal = -10, maxVal = 10;
                    for (const b of data.broadcasts) {
                        const pct = ((b.d_clock_ms - minVal) / (maxVal - minVal)) * 100;
                        const agrees = b.agrees ? '‚úì' : '‚úó';
                        const agreeColor = b.agrees ? 'var(--accent-green)' : 'var(--accent-red)';
                        
                        html += `<div class="broadcast-row">
                            <div class="broadcast-name">${b.station} ${b.frequency}</div>
                            <div class="broadcast-bar-container">
                                <div class="broadcast-marker" style="left: 50%;"></div>
                                <div class="broadcast-marker" style="left: ${pct}%; background: ${b.agrees ? 'var(--accent-green)' : 'var(--accent-red)'}; width: 6px;"></div>
                            </div>
                            <div class="broadcast-value">${b.d_clock_ms.toFixed(2)} ¬±${b.uncertainty_ms.toFixed(1)} ms</div>
                            <div class="broadcast-status" style="color: ${agreeColor};">${agrees}</div>
                        </div>`;
                    }
                }
                
                container.innerHTML = html;
            } catch (err) {
                console.error('Error loading consensus:', err);
                container.innerHTML = `<div class="loading">Error: ${err.message}</div>`;
            }
        }
        
        // Load Geographic Propagation
        async function loadGeographic() {
            const container = document.getElementById('geo-container');
            try {
                const response = await fetch('/api/v1/phase2/propagation-paths');
                const data = await response.json();
                
                let html = '<div class="geo-paths">';
                
                if (data.paths && data.paths.length > 0) {
                    for (const path of data.paths) {
                        html += `<div class="geo-path">
                            <div class="geo-station" style="color: ${path.station === 'WWV' ? 'var(--accent-blue)' : path.station === 'WWVH' ? 'var(--accent-purple)' : 'var(--accent-green)'}">
                                ${path.station}
                            </div>
                            <div class="geo-details">
                                <div class="geo-detail">
                                    <span class="geo-detail-label">Distance</span>
                                    <span class="geo-detail-value">${path.distance_km ? path.distance_km.toFixed(0) + ' km' : '‚Äî'}</span>
                                </div>
                                <div class="geo-detail">
                                    <span class="geo-detail-label">Bearing</span>
                                    <span class="geo-detail-value">${path.bearing ? path.bearing.toFixed(0) + '¬∞' : '‚Äî'}</span>
                                </div>
                                <div class="geo-detail">
                                    <span class="geo-detail-label">Mode</span>
                                    <span class="geo-detail-value">${path.propagation_mode || '‚Äî'}</span>
                                </div>
                                <div class="geo-detail">
                                    <span class="geo-detail-label">Delay</span>
                                    <span class="geo-detail-value">${path.delay_ms ? path.delay_ms.toFixed(1) + ' ms' : '‚Äî'}</span>
                                </div>
                            </div>
                            <div class="geo-signal">
                                ${renderSignalStrength(path.best_snr_db, true)}
                            </div>
                        </div>`;
                    }
                } else {
                    html += '<div class="loading">No path data available</div>';
                }
                
                html += '</div>';
                container.innerHTML = html;
            } catch (err) {
                console.error('Error loading geographic:', err);
                container.innerHTML = `<div class="loading">Error: ${err.message}</div>`;
            }
        }
        
        // Load Diurnal Pattern
        async function loadDiurnal() {
            const container = document.getElementById('diurnal-chart');
            try {
                const response = await fetch('/api/v1/phase2/diurnal-pattern');
                const data = await response.json();
                
                let html = '';
                
                if (data.channels && data.channels.length > 0) {
                    for (const ch of data.channels) {
                        html += `<div class="diurnal-row">
                            <div class="diurnal-label">${ch.channel.replace('WWV ', '').replace('MHz', '')}</div>
                            <div class="diurnal-bar">`;
                        
                        // Render 24 hour segments
                        if (ch.hours && ch.hours.length === 24) {
                            for (let h = 0; h < 24; h++) {
                                const seg = ch.hours[h];
                                const cls = seg.dominant === 'WWV' ? 'wwv' : 
                                           seg.dominant === 'WWVH' ? 'wwvh' : 
                                           seg.dominant === 'MIXED' ? 'mixed' : 'none';
                                html += `<div class="diurnal-segment ${cls}" style="width: ${100/24}%;" title="${h}:00 - ${seg.dominant}"></div>`;
                            }
                        } else {
                            html += '<div class="diurnal-segment none" style="width: 100%;"></div>';
                        }
                        
                        html += `</div></div>`;
                    }
                    
                    // Time axis
                    html += '<div class="diurnal-time-axis">';
                    for (let h = 0; h <= 24; h += 6) {
                        html += `<span>${h.toString().padStart(2, '0')}:00</span>`;
                    }
                    html += '</div>';
                } else {
                    html = '<div class="loading">Collecting diurnal data...</div>';
                }
                
                container.innerHTML = html;
            } catch (err) {
                console.error('Error loading diurnal:', err);
                container.innerHTML = `<div class="loading">Error: ${err.message}</div>`;
            }
        }
        
        // Refresh all panels
        function refreshAll() {
            loadReceptionMatrix();
            loadConsensus();
            loadGeographic();
            loadDiurnal();
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            refreshAll();
            // Auto-refresh every 60 seconds
            setInterval(refreshAll, 60000);
        });
    </script>
    <script src="utils/utc-time.js"></script>
    <script src="components/theme-toggle.js"></script>
    <script src="components/navigation.js"></script>
</body>
</html>
