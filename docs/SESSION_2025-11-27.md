# Development Session: November 27, 2025

## Session Summary

This session focused on **enhancing the WWV/WWVH discrimination system** with multi-evidence classification, ground truth integration, and improved single-peak BCD assignment.

---

## 1. Reprocessing Script Enhancement

**File:** `scripts/reprocess_discrimination.py`

### Added Parameters
- `--start-hour` (0-23, default 0)
- `--end-hour` (0-23, default 23)

### Purpose
Enable granular reprocessing of specific time windows for faster testing iterations. A 2-hour window takes ~5 minutes vs ~40 minutes for a full day.

### Usage Examples
```bash
# Reprocess specific hours (fast testing)
python3 scripts/reprocess_discrimination.py --date 20251127 --channel "WWV 10 MHz" --start-hour 9 --end-hour 11

# Keep existing data and append
python3 scripts/reprocess_discrimination.py --date 20251127 --channel "WWV 10 MHz" --start-hour 6 --end-hour 12 --keep-existing
```

---

## 2. Advanced Voting Methods Added

**File:** `src/signal_recorder/wwvh_discrimination.py`

### New Votes in `finalize_discrimination()`

| Vote | Method | Weight | Trigger Condition |
|------|--------|--------|-------------------|
| 5 | 500/600 Hz Ground Truth | 10.0 | Exclusive minutes (14/hour) |
| 6 | Differential Doppler | 2.0 | ΔfD > 0.05 Hz, quality > 0.3 |
| 7 | Test Signal ↔ BCD ToA Coherence | 3.0 | Minutes 8/44, ToA offset < 5ms |
| 8 | Harmonic Power Ratio | 1.5 | |P_500→1000 - P_600→1200| > 3dB |

### Implementation Details

**VOTE 5 - 500/600 Hz Ground Truth:**
- WWV-only minutes: 1, 16, 17, 19
- WWVH-only minutes: 2, 43, 44, 45, 46, 47, 48, 49, 50, 51
- Total: 14 ground truth minutes per hour
- Weight: 10.0 (highest tier)

**VOTE 6 - Differential Doppler:**
- Compares Doppler std deviation between stations
- Cleaner Doppler correlates with stronger signal
- Cross-validates with power ratio

**VOTE 7 - Test Signal ToA vs BCD ToA:**
- Both modulated simultaneously in minutes 8/44
- If ToA offset < 5ms, timing is coherent
- Boosts confidence in test signal station

**VOTE 8 - Harmonic Power Ratio:**
- 500 Hz → 1000 Hz (WWV timing marker) harmonic ratio
- 600 Hz → 1200 Hz (WWVH timing marker) harmonic ratio
- Cross-validates with power ratio

---

## 3. Harmonic Power Ratio Measurement

### New Fields in `DiscriminationResult`
```python
harmonic_ratio_500_1000: Optional[float] = None  # P_1000/P_500 in dB
harmonic_ratio_600_1200: Optional[float] = None  # P_1200/P_600 in dB
```

### Detection Logic
In `detect_500_600hz_tone()`:
- Measures power at 500, 600, 1000, and 1200 Hz simultaneously
- Calculates harmonic ratios: `10 * log10(P_harmonic / P_fundamental)`
- Returns ratios alongside tone detection

### CSV Output
Added columns 25-26 (now 31 total columns):
- `harmonic_ratio_500_1000`
- `harmonic_ratio_600_1200`

---

## 4. Multi-Evidence BCD Single-Peak Classification

### Problem
When BCD correlation detects only one peak (single station), the previous code:
1. Tried geographic ToA prediction
2. Fell back to power ratio (but only if > 3dB difference)
3. **Defaulted to WWV** if no clear evidence ← BUG

### Solution: Multi-Evidence Voting with Exclusion

**Evidence Sources:**
| Evidence | Weight | Effect |
|----------|--------|--------|
| 500/600 Hz Ground Truth | 10.0 | **DEFINITIVE** + sets exclusion flag |
| Geographic ToA Prediction | 3.0 | Confirmatory |
| Power Ratio > 3dB | 5.0 | Strong indicator |
| Power Ratio 1-3dB | 2.0 | Moderate indicator |
| Power Ratio < 1dB | 0.5 | Weak indicator |
| Tick SNR Difference > 3dB | 2.0 | Confirmatory |

**Exclusion Logic:**
```python
if ground_truth_station == 'WWVH':
    exclusion_wwv = True  # Cannot be WWV
    wwv_votes = 0.0       # Zero out WWV votes
```

**New Detection Types:**
- `single_peak_wwv_gt` / `single_peak_wwvh_gt` - Ground truth confirmed
- `single_peak_wwv_multi` / `single_peak_wwvh_multi` - Multi-evidence confirmed
- `single_peak_wwv_ambig` / `single_peak_wwvh_ambig` - Ambiguous but leaning
- `single_peak_unclassified` - No evidence (both amplitudes = 0)

### Function Signature Changes

`bcd_correlation_discrimination()` now accepts:
```python
timing_power_ratio_db: Optional[float] = None,
ground_truth_station: Optional[str] = None,
wwv_tick_snr_db: Optional[float] = None,
wwvh_tick_snr_db: Optional[float] = None
```

`detect_bcd_discrimination()` wrapper updated to pass all evidence.

---

## 5. CSV Format Update

### New Column Count: 31 (was 29)

### Column Order
```
timestamp_utc, minute_timestamp, minute_number,
wwv_detected, wwvh_detected, wwv_power_db, wwvh_power_db,
power_ratio_db, differential_delay_ms,
tone_440hz_wwv_detected, tone_440hz_wwv_power_db,
tone_440hz_wwvh_detected, tone_440hz_wwvh_power_db,
dominant_station, confidence, tick_windows_10sec,
bcd_wwv_amplitude, bcd_wwvh_amplitude, bcd_differential_delay_ms,
bcd_correlation_quality, bcd_windows,
tone_500_600_detected, tone_500_600_power_db, tone_500_600_freq_hz,
tone_500_600_ground_truth_station,
harmonic_ratio_500_1000, harmonic_ratio_600_1200,  # NEW
bcd_minute_validated, bcd_correlation_peak_quality,
inter_method_agreements, inter_method_disagreements
```

### Files Updated
- `discrimination_csv_writers.py` - DiscriminationRecord dataclass and write method
- `analytics_service.py` - Record creation
- `reprocess_discrimination.py` - CSV header and data writing

---

## 6. Documentation Created

### `docs/DISCRIMINATION_SYSTEM.md`
Comprehensive technical documentation covering:
1. Problem statement (harmonics, intermodulation, multipath)
2. Discriminating features (time-domain, frequency-domain, ground truth)
3. All 8 voting methods with weights and conditions
4. Voting architecture and decision algorithm
5. CSV output format specification
6. Future enhancement roadmap

---

## 7. Bug Fixes

### Fix 1: Single-Peak Default to WWV
**Location:** `bcd_correlation_discrimination()` lines 2138-2174  
**Problem:** When power ratio was unclear (< 3dB), code defaulted to WWV  
**Solution:** Use power ratio direction even for marginal cases; unclassified peaks get (0, 0) amplitudes

### Fix 2: NameError in tick_results
**Location:** `analyze_minute_with_440hz()` line 2571  
**Problem:** Used undefined variable `tick_results`  
**Solution:** Changed to `result.tick_windows_10sec`

---

## Files Modified

| File | Changes |
|------|---------|
| `scripts/reprocess_discrimination.py` | Added --start-hour, --end-hour params; harmonic ratio columns |
| `src/signal_recorder/wwvh_discrimination.py` | VOTE 5-8; multi-evidence BCD; harmonic measurement |
| `src/signal_recorder/discrimination_csv_writers.py` | Harmonic ratio fields; 31-column format |
| `src/signal_recorder/analytics_service.py` | Pass harmonic ratios to record |
| `docs/DISCRIMINATION_SYSTEM.md` | New - comprehensive system documentation |

---

## Testing

After these changes, reprocess with:
```bash
python3 scripts/reprocess_discrimination.py --date 20251127 --channel "WWV 10 MHz"
```

Expected improvements:
- Correct WWVH assignment during 06:00-12:00 UTC when WWVH was audibly dominant
- Ground truth minutes (43-51 each hour) should show WWVH BCD correctly
- No false WWV assignments during exclusive WWVH tone minutes
