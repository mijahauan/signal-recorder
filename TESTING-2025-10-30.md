# Testing Guide - Audio & WWV Tone Detection Fixes
**Date:** 2025-10-30 → 2025-10-31  
**Fixes Applied:** Choppy audio streaming & WWV tone detection

---

## Changes Made

### Fix #1: Audio Streaming (audio_streamer.py)
- **Chunk size:** 1600 samples (200ms) → 400 samples (50ms)
- **Silence chunks:** Fixed to match audio chunk size (400 samples)
- **Timeout:** Reduced from 1.0s → 0.05s (50ms) to prevent long gaps
- **Queue buffer:** Updated to 5 seconds (100 × 400 samples @ 8kHz)
- **Why:** Browsers need smaller chunks for smooth real-time audio playback
- **Expected:** Audio should be clear and continuous, not stuttering

### Fix #2: WWV Tone Detection (grape_rtp_recorder.py)
- **CRITICAL FIX:** Now tracks timestamp of FIRST sample in buffer (was using LAST packet timestamp)
- **This caused:** ~1200ms timing errors → Should now be <50ms
- **Envelope threshold:** 3% → 15% (better sensitivity)
- **Min duration:** 0.6s → 0.5s (accommodate variations)
- **Max duration:** 1.0s → 1.2s (allow for fading)
- **Detection window:** 3s (:59-:02) → 6s (:58-:03) (more reliable)
- **Signal normalization:** Added proper IQ amplitude normalization
- **Logging:** Changed rejection logging from DEBUG → INFO for visibility

---

## Testing Steps

### 0. Quick Audio Test (Optional - Bypass Web UI)

Test audio processing directly without the web UI:

```bash
cd /home/mjh/git/signal-recorder
python3 test-audio-direct.py 5000000 5  # SSRC, duration in seconds
aplay /tmp/wwv-audio-test.wav
```

**Expected:** Clear WWV audio with announcements and tones. If this works but web audio doesn't, the issue is in the streaming pipeline.

### 1. Restart Daemon (if running)

```bash
# Check if daemon is running
ps aux | grep signal-recorder

# If running, restart it to pick up changes
pkill -INT signal-recorder
sleep 2

# Start with your config
cd /home/mjh/git/signal-recorder
source venv/bin/activate
signal-recorder daemon --config config/grape-S000171.toml
```

### 2. Test Audio Streaming

```bash
# Start web UI (if not running)
cd /home/mjh/git/signal-recorder/web-ui
node simple-server.js
```

**In browser:**
1. Navigate to `http://localhost:3000/monitoring`
2. Click the 🔈 button next to a WWV channel
3. **Listen:** Audio should be smooth and continuous, not choppy
4. **Expect:** Clear WWV time announcements, 1000 Hz tone, second ticks

### 3. Monitor WWV Tone Detection

**Watch logs in real-time:**
```bash
# Follow daemon logs
tail -f /tmp/signal-recorder-daemon.log | grep -E "WWV tone|REJECTED"
```

**What to look for around each minute boundary (e.g., 11:00:00, 11:01:00):**

✅ **Good signs:**
```
WWV-10.0: Checking for WWV tone (buffer=6000 samples @ 3 kHz, time=1730339940.0, :mm.00)
WWV-10.0: WWV tone detected! Timing error: +2.3 ms (detection #1)
```

⚠️ **Diagnostic signs (if no detection):**
```
WWV detector: REJECTED duration=0.345s (need 0.5-1.2s), onset_idx=450, offset_idx=1485, max_env=0.234
WWV detector: No edges found - rising=0, falling=0, above_pct=2.3%, max_env=0.045
```

### 4. Check Statistics

```bash
# View tone detection stats
cat /tmp/signal-recorder-stats.json | python3 -m json.tool | grep -A 15 "timing_validation"
```

**Look for:**
- `"wwv_detections"`: Should increment each minute (if signal is good)
- `"wwv_timing_errors"`: Should show array of timing errors in milliseconds
- Detection rate: Expect 50-90% depending on propagation conditions

### 5. Run Diagnostic Script

```bash
cd /home/mjh/git/signal-recorder
python3 diagnose_wwv_tone.py
```

This will:
- Wait for :55 seconds
- Capture 10 seconds of data
- Analyze for 1000 Hz tone
- Save plot to `/tmp/wwv_tone_diagnosis.png`

**Good result:**
```
Results:
  Max envelope: 0.523456
  Above threshold: 45.2%
  Rising edges: 1, Falling edges: 1
  Tone 1: 0.823s at +5.0s (minute second: 0.0)
```

### 6. Compare WWV vs WWVH

```bash
python3 test_wwv_vs_wwvh.py
```

This tests both:
- WWV (Fort Collins): 1000 Hz
- WWVH (Hawaii): 1200 Hz

**Expected for CONUS stations:** WWV should be stronger (you're closer to Fort Collins)

---

## Troubleshooting

### Audio Still Choppy
- Check network connection (multicast packets arriving?)
- Verify web UI restarted to pick up Python changes
- Check browser console for errors (F12)

### No WWV Tone Detections

**Check signal strength:**
```bash
# Look at IQ data magnitude in logs
grep "TONE RESAMPLE OUTPUT" /tmp/signal-recorder-daemon.log
```

**Check timing:**
- Are you checking during the right window? (minute boundaries)
- Is NTP synchronized? `timedatectl status`

**Check rejection reasons:**
- Too short: Signal is noisy or intermittent
- No edges: Signal too weak (below 15% threshold)
- Max_env very low (<0.05): Poor propagation, try different frequency

### WWV Signal Weak

Try different frequencies:
- **2.5 MHz** - Good at night
- **5 MHz** - Good morning/evening
- **10 MHz** - Good daytime
- **15 MHz** - Good daytime (high solar activity)

Propagation varies by time of day and solar conditions!

---

## Success Criteria

✅ **Audio Streaming:** Smooth, continuous audio without stuttering  
✅ **WWV Detection:** At least 1-2 detections per 10 minutes (in good conditions)  
✅ **Timing Error:** Mean < 50ms when tones are detected  
✅ **Logs:** Clear diagnostic info showing why detections fail/succeed

---

## Next Steps After Testing

If both fixes work well:
1. Commit changes to git
2. Update CRITICAL-BUG-FIX.md with audio fix
3. Monitor for 24 hours to confirm stability
4. Consider adjusting threshold further based on detection rates

If tone detection still fails:
1. Review rejection messages in logs
2. Run diagnostic scripts to capture actual signal
3. May need to adjust threshold or signal processing
4. Check propagation conditions (time of day, solar weather)

---

**Questions?** Check logs and share the diagnostic output!
